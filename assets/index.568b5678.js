import{C as E,R as H}from"./chatItem.7c25d96c.js";import{_ as $,o as c,g as p,i as r,j as n,t as _,r as l,d as C,T as f,w as a,F as w,h as k,n as O,f as v,k as m,q as R,v as A,u as D,D as M,s as N,p as F,l as j}from"./index.68a2c8a6.js";import{D as z}from"./dialogBase.f04b6973.js";import{A as G}from"./avatar.0dbdb42c.js";import"./roleTag.653a2c77.js";const J={name:"ChatNotice",props:{content:{type:String,default:""}},emits:["onClose","onPinedClick"],computed:{},methods:{onClose(){this.$emit("onClose")},onPinedClick(){this.$emit("onPinedClick")}}},q={class:"chat-notice"},K={class:"icon-box"};function Q(t,e,d,b,o,s){const u=l("van-icon");return c(),p("div",q,[r("div",K,[n(u,{class:"icon",size:"24px",name:"/assets/images/horn.png"})]),r("div",{class:"text",onClick:e[0]||(e[0]=(...g)=>s.onPinedClick&&s.onPinedClick(...g))},_(d.content),1),r("div",{class:"icon-box",onClick:e[1]||(e[1]=(...g)=>s.onClose&&s.onClose(...g))},[n(u,{class:"icon close",size:"24px",name:"cross"})])])}const W=$(J,[["render",Q],["__scopeId","data-v-bf332d48"]]);const X={name:"ChatBar",props:{reply:{type:Object,default:null}},emits:["chatBarToolClick","onFocus"],data(){return{text:"",lastSendTime:0,slowSendTimer:0,sendCountdown:"",showTools:!1,toolList:[{key:"redPacket",icon:"/assets/images/redPacketRed.png",text:"\u7EA2\u5305"}],sendLoading:!1}},computed:{status(){if(this.$store.state.group.isJoined){if(this.$store.state.group.status==0&&this.$store.state.group.currentUser.status==0)return 0;if(this.$store.state.group.status==1||this.$store.state.group.currentUser.status==1)return 1;if(this.$store.state.group.status==2||this.$store.state.group.currentUser.status==2)return 2;if(this.$store.state.group.status==3||this.$store.state.group.currentUser.status==3)return 3}else return-1;return-2},bannedExpiredTime(){return this.$store.state.group.status==1?this.$dayjs.unix(this.$store.state.group.bannedExpiredTime).format("YYYY-MM-DD HH:mm:ss"):this.$dayjs.unix(this.$store.state.group.currentUser.bannedExpiredTime).format("YYYY-MM-DD HH:mm:ss")},replyItem:{get(){return this.reply},set(t){this.$emit("update:reply",t)}},inputPlaceholder(){return this.$store.state.group.tokenPrice.price?`\u8F93\u5165\u804A\u5929 | $${this.$store.state.group.tokenPrice.price.toFixed(1)}  ${this.$store.state.group.tokenPrice.direction=="up"?"+":""}${this.$store.state.group.tokenPrice.priceChange}%`:"\u8F93\u5165\u804A\u5929"},inputPlaceholderColor(){return this.$store.state.group.tokenPrice.price?this.$store.state.group.tokenPrice.direction=="up"?"token-price-up":"token-price-down":""}},methods:{focus(){this.showTools=!1,this.$emit("onFocus")},async onSend(){if(!!this.text.trim()){this.sendLoading=!0;try{(await C.group.sendMsg(this.text,this.$store.state.group.groupId,this.replyItem?this.replyItem.toId:0,1)).status==1&&(this.replyItem=null,this.text="",this.showTools=!1,this.lastSendTime=parseInt(new Date().getTime()/1e3))}catch(t){console.log(t),f("Send Message Error")}finally{this.sendLoading=!1}this.status==3&&(this.sendCountdown=this.calcCountdown(30),this.slowSendTimer=setInterval(()=>{let e=parseInt(new Date().getTime()/1e3),d=this.lastSendTime+30-e;d>0?this.sendCountdown=this.calcCountdown(d):(clearInterval(this.slowSendTimer),this.slowSendTimer=0,this.sendCountdown="")},1e3))}},calcCountdown(t){let e=parseInt(t/60),d=t%60;return e>0?e+":"+(d+"").padStart(2,"0"):d+""},onJoin(){this.$store.dispatch("joinGroup",this.$store.state.group.groupId)},onChatBarToolClick(t){this.$emit("chatBarToolClick",t)}}},Z={class:"chat-bar"},ee={key:0,class:"action-btn"},te=m("\u52A0\u5165"),se={key:0,class:"reply"},oe={class:"icon-box"},ne={class:"reply-info"},ie={class:"to"},re=m("\u56DE\u590D"),ae={class:"msg"},le={class:"action"},de={class:"tools"},ce={key:2,class:"action-btn"},ue={key:3,class:"action-btn"},he=m("\u6C38\u4E45\u7981\u8A00");function pe(t,e,d,b,o,s){const u=l("van-button"),g=l("van-icon"),x=l("van-field"),T=l("van-grid-item"),B=l("van-grid");return c(),p("div",Z,[s.status==-1?(c(),p("div",ee,[n(u,{class:"join",type:"default",round:"",block:"",onClick:s.onJoin},{default:a(()=>[te]),_:1},8,["onClick"])])):s.status==0||s.status==3?(c(),p(w,{key:1},[s.replyItem?(c(),p("div",se,[r("div",oe,[n(g,{class:"icon",size:"24px",name:"/assets/images/reply.png"})]),r("div",ne,[r("div",ie,[re,r("span",null,_(s.replyItem.toName),1)]),r("div",ae,_(s.replyItem.toMsg),1)]),r("div",{class:"icon-box",onClick:e[0]||(e[0]=h=>d.reply=null)},[n(g,{class:"icon close",size:"24px",name:"cross"})])])):k("",!0),r("div",le,[n(u,{class:"btn",icon:"/assets/images/add.png",onClick:e[1]||(e[1]=h=>o.showTools=!o.showTools)}),n(x,{class:O(["input",s.inputPlaceholderColor]),onFocus:s.focus,modelValue:o.text,"onUpdate:modelValue":e[2]||(e[2]=h=>o.text=h),placeholder:s.inputPlaceholder,type:"textarea",rows:"1",autosize:{maxHeight:100},maxlength:"4096"},null,8,["class","onFocus","modelValue","placeholder"]),s.status==3&&o.sendCountdown?(c(),v(u,{key:0,class:"btn",disabled:""},{default:a(()=>[m(_(o.sendCountdown),1)]),_:1})):(c(),v(u,{key:1,class:"btn",icon:"/assets/images/send.png",onClick:s.onSend,loading:o.sendLoading},null,8,["onClick","loading"]))]),R(r("div",de,[n(B,{"column-num":4,"icon-size":"54px",border:!1},{default:a(()=>[(c(!0),p(w,null,D(o.toolList,h=>(c(),v(T,{key:h.key,icon:h.icon,text:h.text,onClick:I=>t.$emit("chatBarToolClick",h.key)},null,8,["icon","text","onClick"]))),128))]),_:1})],512),[[A,o.showTools]])],64)):s.status==1?(c(),p("div",ce,[n(u,{type:"default",disabled:"",round:"",block:""},{default:a(()=>[m("\u7981\u8A00\u4E2D, \u89E3\u7981\u65F6\u95F4"+_(s.bannedExpiredTime),1)]),_:1})])):s.status==2?(c(),p("div",ue,[n(u,{type:"default",disabled:"",round:"",block:""},{default:a(()=>[he]),_:1})])):k("",!0)])}const me=$(X,[["render",pe],["__scopeId","data-v-05be1844"]]);const ge={name:"Chat",components:{ChatItem:E,ChatNotice:W,DialogBase:z,RedPacket:H,ChatBar:me,Avatar:G},data(){return{listLoading:!1,listFinished:!1,banVisable:!1,banChecked:"2",banUserAddress:"",selectBanExpiredVisable:!1,banExpired:new Date,banMinTime:new Date,removeVisable:!1,removeChecked:"1",removeUserAddress:"",pinedVisible:!0,reply:null,offset:0}},computed:{group(){return this.$store.state.group},groupTitle(){return this.$f.getGroupShowName({address:this.group.groupId.split("-")[0],name:this.group.name,nickname:this.group.nickname})}},watch:{"$store.state.ws.status"(t){let e;t==1?e=f.loading({message:"Loading...",forbidClick:!0}):e&&e.clear()},"$store.state.group.msgList.length":{handler(t,e){this.$refs.rightBody.scrollTop+this.$refs.rightBody.clientHeight==this.$refs.rightBody.scrollHeight&&this.scrollToBottom()},deep:!0},"$store.state.group.status"(t){switch(t){case 1:f("\u8BE5\u7FA4\u5DF2\u88AB\u7981\u8A00\u5904\u7F5A\u81F3"+this.$dayjs.unix(this.$store.state.group.bannedExpired).format("YYYY-MM-DD HH:mm:ss"));break;case 2:f("\u8BE5\u7FA4\u5DF2\u88AB\u6C38\u4E45\u7981\u8A00\u5904\u7F5A");break;case 3:f("\u8BE5\u7FA4\u5DF2\u88AB\u6162\u901F\u53D1\u8A00\u5904\u7F5A,\u53D1\u8A00\u95F4\u969430\u79D2");break;case 4:M.alert({title:"\u63D0\u793A",message:"\u8BE5\u7FA4\u5DF2\u88AB\u5C01\u7981"}).then(()=>{this.$router.push("/chats")});break}},"$store.state.group.currentUser.status"(t){switch(t){case 5:M.alert({title:"\u63D0\u793A",message:"\u60A8\u5DF2\u88AB\u8E22\u51FA\u7FA4\u804A"}).then(()=>{this.$router.push("/chats")});break}}},methods:{onLoad(){this.offset=-999999,this.loadLastPage()},async loadLastPage(){this.$refs.rightBody.querySelectorAll(".van-cell")[0];let t=-1;this.$store.state.group.msgList.length>0&&(t=this.$store.state.group.msgList[0].id);try{let e=await C.group.getMsgList(this.$store.state.group.groupId,10,t);if(e.status==1){if(e.data.length>0)for(let d=e.data.length-1;d>=0;d--)this.$store.commit("addMsgUnshift",e.data[d]);e.data.length<10&&(this.listFinished=!0)}}catch{}finally{this.$nextTick(()=>{this.listLoading=!1,this.$nextTick(async()=>{await N(500),this.$refs.rightBody.scrollTop=1,this.offset=0})})}},onBanUser(t){this.banMinTime=new Date;let e=new Date;this.banExpired=new Date(e.setDate(e.getDate()+1)),this.banUserAddress=t,this.banVisable=!0},clickSelectBanExpired(){this.banChecked="1",this.selectBanExpiredVisable=!0},async banConfirm(){let t=0;this.banChecked=="1"&&(t=this.$dayjs(this.banExpired).unix()),(await C.groupMember.banMember(this.group.groupId,this.banUserAddress,parseInt(this.banChecked),t)).status==1&&f.success("\u7981\u8A00\u7528\u6237\u6210\u529F"),this.banUserAddress=""},onRemoveUser(t){this.removeUserAddress=t,this.removeVisable=!0},async removeConfirm(){this.removeChecked=="2"?(await C.user.blockUser(this.removeUserAddress)).status==1&&f.success("\u8E22\u51FA\u7528\u6237\u6210\u529F"):(await C.groupMember.removeMember(this.group.groupId,this.removeUserAddress)).status==1&&f.success("\u8E22\u51FA\u7528\u6237\u6210\u529F"),this.removeUserAddress=""},onReply(t){this.reply={toId:t.id,toName:this.$f.getUserShowName(t),toMsg:t.content}},onPinedClick(){this.$router.push("/group/"+this.$route.params.groupId+"/pined")},toChats(){this.$router.push("/chats")},toGroupDetail(){this.$router.push("/group/"+this.$route.params.groupId+"/detail")},onChatBarToolClick(t){switch(t){case"redPacket":this.$router.push("/group/"+this.$route.params.groupId+"/createRedPacket");break}},scrollToBottom(){this.$nextTick(()=>{this.$refs.rightBody.scrollTop=this.$refs.rightBody.scrollHeight}),this.scrollTop=this.$refs.rightBody.scrollHeight},addMsgUnshift(t){this.msgList.unshift(t),this.formatMsgList()},formatMsgList(){let t="";for(let e of this.msgList)if(e.type==6)e.redPacket=JSON.parse(e.content);else if(e.type==1){let d=this.$dayjs.unix(e.sendTime),b=d.format("YYYY-MM-DD");t!=b?(e.showSendTime=d.format("YYYY-MM-DD HH:mm"),t=b):e.showSendTime=d.format("HH:mm")}}},mounted(){this.$store.state.group.scrollTop==-1?this.scrollToBottom():this.$refs.rightBody.scrollTop=this.$store.state.group.scrollTop},beforeRouteLeave(t,e){console.log("beforeRouteLeave"),this.scrollTop=this.$refs.rightBody.scrollTop,this.$store.commit("setScrollTop",this.$refs.rightBody.scrollTop)}},fe=t=>(F("data-v-8758541d"),t=t(),j(),t),_e={class:"chat-container",ref:"container"},ve={ref:"header"},be={class:"nav-bar"},Ce={class:"info"},ke={class:"title-line"},ye={class:"title"},we={class:"desc"},xe=fe(()=>r("i",{class:"iconfont icon-set"},null,-1)),Te={class:"chat-content",ref:"rightBody"},Be=m("\u8E22\u51FA\u5F53\u524D\u7FA4\u804A\u53CA\u5220\u9664\u6240\u6709\u6D88\u606F"),$e=m("\u8E22\u51FA Ta \u7684\u6240\u6709\u7FA4\u804A\u53CA\u5220\u9664\u6240\u6709\u6D88\u606F"),Ie=m("\u6C38\u4E45\u7981\u8A00"),Ue=m("\u7981\u8A00\u81F3");function Ve(t,e,d,b,o,s){var L;const u=l("van-icon"),g=l("Avatar"),x=l("van-nav-bar"),T=l("ChatNotice"),B=l("ChatItem"),h=l("van-cell"),I=l("van-list"),S=l("ChatBar"),y=l("van-radio"),U=l("van-radio-group"),V=l("DialogBase"),P=l("van-datetime-picker"),Y=l("van-popup");return c(),p(w,null,[r("section",_e,[r("div",ve,[n(x,{fixed:"",placeholder:"","safe-area-inset-top":"",onClickLeft:s.toChats,onClickRight:s.toGroupDetail},{left:a(()=>[n(u,{name:"wap-nav"})]),title:a(()=>[r("div",be,[s.group.groupId?(c(),v(g,{key:0,class:"avatar",image:s.group.image?s.group.image:`https://ave.s3.ap-east-1.amazonaws.com/token_icon/bsc/${t.$route.params.groupId.split("-")[0]}.png`,address:s.group.address},null,8,["image","address"])):k("",!0),r("div",Ce,[r("div",ke,[r("div",ye,_(s.groupTitle),1),t.$store.state.group.providers&&t.$store.state.group.providers.length>0?(c(),v(u,{key:0,size:"0.4rem",name:"/assets/images/certification.png"})):k("",!0)]),r("div",we,_(s.group.totalMembers)+"\u4EBA",1)])])]),right:a(()=>[xe]),_:1},8,["onClickLeft","onClickRight"]),((L=s.group.pinedMsgList)==null?void 0:L.length)>0&&o.pinedVisible?(c(),v(T,{key:0,onOnClose:e[0]||(e[0]=i=>o.pinedVisible=!1),content:s.group.pinedMsgList[s.group.pinedMsgList.length-1].content,onOnPinedClick:s.onPinedClick},null,8,["content","onOnPinedClick"])):k("",!0)],512),r("div",Te,[n(I,{loading:o.listLoading,"onUpdate:loading":e[1]||(e[1]=i=>o.listLoading=i),class:"chat-list",direction:"up",onLoad:s.onLoad,"immediate-check":!1,finished:o.listFinished,"loading-text":"\u8F7D\u5165\u4E2D",offset:o.offset},{default:a(()=>[(c(!0),p(w,null,D(s.group.msgList,i=>(c(),v(h,{key:i.id},{default:a(()=>[n(B,{source:i,onOnReply:Le=>s.onReply(i),onOnRemoveUser:s.onRemoveUser,onOnBanUser:s.onBanUser},null,8,["source","onOnReply","onOnRemoveUser","onOnBanUser"])]),_:2},1024))),128))]),_:1},8,["loading","onLoad","finished","offset"])],512),n(S,{reply:o.reply,"onUpdate:reply":e[2]||(e[2]=i=>o.reply=i),onChatBarToolClick:s.onChatBarToolClick,onOnFocus:s.scrollToBottom},null,8,["reply","onChatBarToolClick","onOnFocus"])],512),n(V,{visible:o.removeVisable,"onUpdate:visible":e[4]||(e[4]=i=>o.removeVisable=i),title:"\u8E22\u51FA\u7FA4\u804A",showConfirmButton:!0,showCancelButton:!0,onOnConfirm:s.removeConfirm},{default:a(()=>[n(U,{modelValue:o.removeChecked,"onUpdate:modelValue":e[3]||(e[3]=i=>o.removeChecked=i)},{default:a(()=>[n(y,{name:"1"},{default:a(()=>[Be]),_:1}),n(y,{name:"2"},{default:a(()=>[$e]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["visible","onOnConfirm"]),n(V,{visible:o.banVisable,"onUpdate:visible":e[11]||(e[11]=i=>o.banVisable=i),title:"\u7981\u8A00\u65F6\u6548\u8BBE\u7F6E",showConfirmButton:!0,showCancelButton:!0,onOnConfirm:s.banConfirm},{default:a(()=>[n(U,{modelValue:o.banChecked,"onUpdate:modelValue":e[10]||(e[10]=i=>o.banChecked=i)},{default:a(()=>[n(y,{name:"2"},{default:a(()=>[Ie]),_:1}),n(y,{name:"1"},{default:a(()=>[Ue]),_:1}),r("div",{class:"ban-date-time",onClick:e[5]||(e[5]=(...i)=>s.clickSelectBanExpired&&s.clickSelectBanExpired(...i))},_(t.$dayjs(o.banExpired).format("YYYY-MM-DD HH:mm:ss")),1),n(Y,{show:o.selectBanExpiredVisable,"onUpdate:show":e[9]||(e[9]=i=>o.selectBanExpiredVisable=i),teleport:"#app",position:"bottom"},{default:a(()=>[n(P,{modelValue:o.banExpired,"onUpdate:modelValue":e[6]||(e[6]=i=>o.banExpired=i),type:"datetime","min-date":o.banMinTime,onCancel:e[7]||(e[7]=i=>o.selectBanExpiredVisable=!1),onConfirm:e[8]||(e[8]=i=>o.selectBanExpiredVisable=!1)},null,8,["modelValue","min-date"])]),_:1},8,["show"])]),_:1},8,["modelValue"])]),_:1},8,["visible","onOnConfirm"])],64)}const Ee=$(ge,[["render",Ve],["__scopeId","data-v-8758541d"]]);export{Ee as default};
