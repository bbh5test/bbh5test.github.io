import{D as R}from"./dialogBase.4d1dc745.js";import{_ as B,c as E,o as c,a as f,w as l,b as r,d as k,t as u,e as $,f as w,r as h,p as P,g as N,ah as F,k as p,s as D,T as _,ai as q,m as i,F as I,x as W}from"./index.839feb97.js";const M={name:"ChainTrade",components:{DialogBase:R},props:{tradeVisable:{type:Boolean,default:!1},status:{type:Number,default:0},tradeHash:{type:String,default:""}},emits:["update:tradeVisable"],methods:{copy:E}},x=e=>(P("data-v-a156f7ea"),e=e(),N(),e),j={class:"status-content"},G={class:"status-text"},J={key:0},K={key:1},O={key:2},Q={key:3},X={key:4},Y={class:"status-icon"},Z={class:"trade-hash"},ee={key:0},te=x(()=>r("use",{"xlink:href":"#icon-copy"},null,-1)),se=[te],ae={key:1},ne=x(()=>r("span",null,"N/A",-1)),oe=[ne];function ie(e,t,o,A,s,m){const g=h("van-loading"),n=h("van-icon"),b=h("DialogBase");return c(),f(b,{class:"trade-box",visible:o.tradeVisable,"onUpdate:visible":t[2]||(t[2]=d=>o.tradeVisable=d),autoClose:!1,closeable:!1,clickOverlayIsClose:!1,title:e.$t("transactionDetails"),showConfirmButton:!1,showCancelButton:!1},{default:l(()=>[r("div",j,[r("div",G,[o.status==0?(c(),k("span",J,u(e.$t("sendingTransactionToBlockchain")),1)):o.status==1?(c(),k("span",K,u(e.$t("waitingForServiceSyncronizing")),1)):o.status==2?(c(),k("span",O,u(e.$t("transactionSuccess")),1)):o.status==-1?(c(),k("span",Q,u(e.$t("sendTransactionToBlockchainFailed")),1)):o.status==-2?(c(),k("span",X,u(e.$t("servicesyncronizingTimeout")),1)):$("",!0)]),r("div",Y,[o.status==0||o.status==1?(c(),f(g,{key:0,type:"spinner",size:"48px"})):$("",!0),o.status==2?(c(),f(n,{key:1,color:"#07c160",size:"40px",name:"checked"})):$("",!0),o.status==-1||o.status==-2?(c(),f(n,{key:2,color:"#FA5151",size:"40px",name:"clear"})):$("",!0)]),r("div",Z,[w(u(e.$t("txHash")+":")+" ",1),o.status==1||o.status==2||o.status==-2?(c(),k("text",ee,[r("span",{onClick:t[0]||(t[0]=(...d)=>e.jumpToTxDetail&&e.jumpToTxDetail(...d))},u(e.$f.formatAddress(o.tradeHash,6)),1),(c(),k("svg",{class:"icon-svg icon-renzheng","aria-hidden":"true",onClick:t[1]||(t[1]=d=>m.copy(o.tradeHash))},se))])):o.status==0||o.status==-1?(c(),k("text",ae,oe)):$("",!0)])])]),_:1},8,["visible","title"])}const le=B(M,[["render",ie],["__scopeId","data-v-a156f7ea"]]),re="/assets/svg/redPacket/luck.svg",de="/assets/svg/redPacket/redPacket.svg";const ce={name:"CreateRedPacket",components:{ChainTrade:le},computed:{totalAmount(){if(this.type=="0")return this.amount?this.amount:0;if(this.type=="1")if(this.amount&&this.count){const e=Number(this.amount),t=Number(this.count);return F(e).multipliedBy(t).toNumber()}else return 0}},data(){return{tradeVisable:!1,tradeStatus:0,tradeHash:"",type:"0",result:"",showTokenSelect:!1,count:"",chain:"",amount:"",symbol:"",showDeadlinePicker:!1,deadlineList:[{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},{text:this.$t("deadlineList.600"),value:600,showText:this.$t("deadlineList.600Show")},{text:this.$t("deadlineList.1800"),value:1800,showText:this.$t("deadlineList.1800Show")},{text:this.$t("deadlineList.3600"),value:3600,showText:this.$t("deadlineList.3600Show")},{text:this.$t("deadlineList.43200"),value:43200,showText:this.$t("deadlineList.43200Show")},{text:this.$t("deadlineList.86400"),value:86400,showText:this.$t("deadlineList.86400Show")}],deadline:{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},remark:"",tokenAddress:"",contractAddress:"0xad3f6E6d8B3D08Ed7d46988fDb4a324e6F6006C6",tokenList:[],balance:-1,needApprove:!1}},methods:{async approve(){this.tradeStatus=0,this.tradeVisable=!0,this.tradeHash="";try{const e=await p.contract.approve(this.contractAddress,this.tokenAddress);console.log("approve",e),e?(this.tradeHash=e.hash,this.tradeStatus=1,await e.wait(),this.tradeStatus=2,this.needApprove=!1):this.tradeStatus=-1}catch{this.tradeStatus=-1}finally{await D(1e3),this.tradeVisable=!1}},async selectToken(e){this.showTokenSelect=!1,this.tokenAddress=e.address,this.symbol=e.symbol,this.chain=e.chain,this.balance=-1;let t=_.loading();await this.getBalance(),console.log("allowance");const o=await this.allowance();this.needApprove=!o,t.clear()},async getTokenList(){this.tokenList=[];const e=this.$store.state.user.userAddress,t=this.$store.state.chainId;if(t==4){this.tokenList=[{address:"0xaf22f677373352761b7f8faff4c9ad7bd8b6be42",tokenId:"0xaf22f677373352761b7f8faff4c9ad7bd8b6be42-eth",chain:"eth",symbol:"JF",decimals:18,image:"/assets/images/groupAvatar.png",amount:0}];return}const o=_.loading();let s=(await p.user.getUserTokenList(e,q[t])).data.filter(n=>new RegExp("^0x.*$","gi").test(n.id)).map(n=>({address:n.id.toLowerCase(),tokenId:`${n.id}-${n.chain}`.toLowerCase(),chain:n.chain.toLowerCase(),symbol:n.symbol,decimals:n.decimals,image:n.logo_url,amount:n.amount})),m=s.map(n=>n.tokenId),g=await p.redPacket.tokenlistcheck(m);this.tokenList=s.filter(n=>g.data[n.tokenId].riskScore<60),o.clear()},onDeadlineConfirm(e){this.deadline=e,this.showDeadlinePicker=!1},async getBalance(){try{this.balance=await p.contract.getBalance(this.tokenAddress,this.$store.state.user.userAddress)}catch(e){console.log(e),this.$store.state.wallet=="WalletConnect"&&await this.$store.state.provider.disconnect(),this.$store.commit("logout"),this.$store.dispatch("checkLogin")}},async sendRedPacket(){const e=Number(this.amount),t=Number(this.count);if(!this.tokenAddress){_(this.$t("selectTokenFirst"));return}if(e<=0){_(this.$t("amountWarn"));return}if(t<1){_(this.$t("countWarn"));return}if(t>this.$store.state.group.totalMembers){_(this.$t("countGroupWarn"));return}if(Number(this.totalAmount)>this.balance){_(this.$t("blanceSlow"));return}let A=this.deadline.value;if(!await this.allowance()){this.needApprove=!0,_("need approve");return}this.tradeStatus=0,this.tradeVisable=!0;try{const m={_owner:this.$store.state.user.userAddress,token:this.tokenAddress,amount:e,unlockDate:A,quantity:t,kind:this.type};let g=await p.contract.lock(this.contractAddress,m);console.dir(g);let n=await g.wait();this.tradeStatus=1,this.tradeHash=n.transactionHash,this.tradeVisable=!0,console.dir(n);let b=n==null?void 0:n.events,d={};for(let y=b.length-1;y>=0;y--){let L=b[y].topics.some(T=>T==="0x694af1cc8727cdd0afbdd53d9b87b69248bd490224e9dd090e788546506e076f");if(b[y].address==this.contractAddress&&L){d=b[y];break}}let V=d.data.slice(-128,-64);const C=await p.contract.getDecimal(this.tokenAddress),v=await p.contract.getAmount(this.tokenAddress,"0x"+V),S={groupId:this.$route.params.groupId,contractAddress:this.tokenAddress,contractChain:this.chain,contractDecimal:C,count:t,endTime:A,redPacketId:d.topics[1],remark:this.remark,singleAmount:e,symbol:this.symbol,totalAmount:Number(this.totalAmount),tx:n.transactionHash,type:Number(this.type)};await p.redPacket.send(S),this.tradeStatus=2,await D(1e3),this.$router.push({name:"Chat",params:{groupId:this.$route.params.groupId}})}catch(m){console.log(m),this.tradeStatus=-1,await D(1e3),this.tradeVisable=!1}},async auth(){let e=await this.allowance();if(!e){const t=await p.contract.approve(this.contractAddress,this.tokenAddress);console.log("approve",t),t&&(e=await this.allowance())}return e},async allowance(){return await p.contract.allowanceSend({spender:this.contractAddress,tokenAddress:this.tokenAddress,account:this.$store.state.user.userAddress})}},mounted(){this.getTokenList()}},H=e=>(P("data-v-fff4c9a7"),e=e(),N(),e),ue={class:"myChats-container"},he={class:"body"},me={class:"token"},pe={class:"token-symbol"},ke=w("\xA0\xA0 "),fe=H(()=>r("img",{class:"left-icon",src:re,alt:"",srcset:""},null,-1)),ge={class:"desc-text margin-bottom"},be=H(()=>r("img",{class:"left-icon",src:de,alt:"",srcset:""},null,-1)),ve={class:"desc-text margin-bottom"},_e={class:"total"},we={class:"amount"},ye={style:{margin:"16px"}},Ae=w("Approve"),$e={class:"bottom"};function Te(e,t,o,A,s,m){const g=h("van-nav-bar"),n=h("van-radio"),b=h("van-radio-group"),d=h("van-field"),V=h("van-image"),C=h("van-cell"),v=h("van-cell-group"),S=h("van-action-sheet"),y=h("van-picker"),L=h("van-popup"),T=h("van-button"),U=h("van-form"),z=h("ChainTrade");return c(),k(I,null,[r("section",ue,[i(g,{fixed:"","left-arrow":"","safe-area-inset-top":"","z-index":"2",title:e.$t("createRedPacket"),onClickLeft:t[0]||(t[0]=a=>e.$router.push({name:"Chat",params:{groupId:e.$route.params.groupId}}))},null,8,["title"]),r("div",he,[i(U,null,{default:l(()=>[i(d,{name:"type",class:"red-packet-type"},{input:l(()=>[i(b,{modelValue:s.type,"onUpdate:modelValue":t[1]||(t[1]=a=>s.type=a),direction:"horizontal"},{default:l(()=>[i(n,{"checked-color":"#ED4A4A",name:"0"},{default:l(()=>[w(u(e.$t("randomAmount")),1)]),_:1}),i(n,{"checked-color":"#ED4A4A",name:"1"},{default:l(()=>[w(u(e.$t("identicalAmount")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(v,{inset:"",class:"margin-bottom"},{default:l(()=>[i(d,{modelValue:s.symbol,"onUpdate:modelValue":t[2]||(t[2]=a=>s.symbol=a),"is-link":"",readonly:"",name:"picker",label:e.$t("token"),onClick:t[3]||(t[3]=a=>s.showTokenSelect=!0),"input-align":"right"},null,8,["modelValue","label"]),i(S,{show:s.showTokenSelect,"onUpdate:show":t[4]||(t[4]=a=>s.showTokenSelect=a),title:e.$t("settingToken")},{default:l(()=>[r("div",me,[i(v,{inset:""},{default:l(()=>[(c(!0),k(I,null,W(s.tokenList,a=>(c(),f(C,{key:a.address,clickable:"",onClick:Ve=>m.selectToken(a)},{title:l(()=>[r("div",pe,[i(V,{class:"symbol-icon",round:"",width:"0.4rem",height:"0.4rem","icon-size":"0.4rem","lazy-load":"","show-loading":"",src:a.image,"error-icon":"/assets/images/groupAvatar.png"},null,8,["src"]),r("span",null,u(a.symbol),1)])]),value:l(()=>[r("div",null,[r("span",null,u(e.$t("balance"))+": "+u(e.$f.formatNumUnit(a.amount)),1),ke])]),_:2},1032,["onClick"]))),128))]),_:1})])]),_:1},8,["show","title"])]),_:1}),s.type=="0"?(c(),f(v,{key:0,inset:""},{default:l(()=>[i(d,{label:e.$t("totalAmount2"),class:"ipt-num"},{"left-icon":l(()=>[fe]),input:l(()=>[i(d,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":t[5]||(t[5]=a=>s.amount=a),type:"number",maxlength:"10","error-message-align":"right",rules:[{required:!0,message:e.$t("enterAmount")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1})):(c(),f(v,{key:1,inset:""},{default:l(()=>[i(d,{label:e.$t("singleAmount"),class:"ipt-num"},{input:l(()=>[i(d,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":t[6]||(t[6]=a=>s.amount=a),type:"number",maxlength:"10","error-message-align":"right",rules:[{required:!0,message:e.$t("enterAmount")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1})),r("div",ge,u(`${e.$t("availableBalance")} ${s.balance>0?s.balance:"--"} ${s.symbol} `),1),i(v,{inset:""},{default:l(()=>[i(d,{label:e.$t("quantity"),class:"ipt-num"},{"left-icon":l(()=>[be]),input:l(()=>[i(d,{"input-align":"right",modelValue:s.count,"onUpdate:modelValue":t[7]||(t[7]=a=>s.count=a),type:"digit",maxlength:"10","error-message-align":"right",rules:[{required:!0,message:e.$t("enterNumber")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1}),r("div",ve,u(`${e.$t("totalMembers1")} ${e.$store.state.group.totalMembers} ${e.$t("totalMembers2")}`),1),i(v,{inset:"",class:"margin-bottom"},{default:l(()=>[i(d,{modelValue:s.deadline.text,"onUpdate:modelValue":t[8]||(t[8]=a=>s.deadline.text=a),"is-link":"",readonly:"",name:"picker",label:e.$t("deadline"),onClick:t[9]||(t[9]=a=>s.showDeadlinePicker=!0),"input-align":"right"},null,8,["modelValue","label"]),i(L,{show:s.showDeadlinePicker,"onUpdate:show":t[11]||(t[11]=a=>s.showDeadlinePicker=a),position:"bottom"},{default:l(()=>[i(y,{columns:s.deadlineList,onCancel:t[10]||(t[10]=a=>s.showDeadlinePicker=!1),onConfirm:m.onDeadlineConfirm,title:e.$t("settingDeadline"),"confirm-button-text":e.$t("confirm"),"cancel-button-text":e.$t("cancel")},null,8,["columns","onConfirm","title","confirm-button-text","cancel-button-text"])]),_:1},8,["show"])]),_:1}),i(v,{inset:""},{default:l(()=>[i(d,{modelValue:s.remark,"onUpdate:modelValue":t[12]||(t[12]=a=>s.remark=a),rows:"2",autosize:"",placeholder:e.$t("bestWishes"),type:"textarea",maxlength:"20","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1}),r("div",_e,[w(u(e.$t("totalAmount")),1),r("span",we,u(m.totalAmount?m.totalAmount:"--"),1),w(u(s.symbol),1)]),r("div",ye,[s.needApprove?(c(),f(T,{key:0,round:"",block:"",type:"default","native-type":"submit",onClick:m.approve},{default:l(()=>[Ae]),_:1},8,["onClick"])):(c(),f(T,{key:1,round:"",block:"",type:"default","native-type":"submit",onClick:m.sendRedPacket},{default:l(()=>[w(u(e.$t("send")),1)]),_:1},8,["onClick"]))])]),_:1}),r("div",$e,u(`${e.$t("createRedPacketTips1")} ${s.deadline.showText} ${e.$t("createRedPacketTips2")}`),1)])]),i(z,{tradeVisable:s.tradeVisable,"onUpdate:tradeVisable":t[13]||(t[13]=a=>s.tradeVisable=a),status:s.tradeStatus,tradeHash:s.tradeHash},null,8,["tradeVisable","status","tradeHash"])],64)}const Le=B(ce,[["render",Te],["__scopeId","data-v-fff4c9a7"]]);export{Le as default};
