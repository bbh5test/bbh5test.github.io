import{_ as D,D as N,c as F,r as c,o as d,f as C,w as r,i as n,g as m,h as V,t as y,k as A,p as S,l as P,d as g,s as I,j as a,F as U}from"./index.12dd02ce.js";const z={name:"ChainTrade",components:{DialogBase:N},props:{tradeVisable:{type:Boolean,default:!1},status:{type:Number,default:0},tradeHash:{type:String,default:""}},emits:["update:tradeVisable"],methods:{copy:F}},H=e=>(S("data-v-3fb3f7d6"),e=e(),P(),e),E={class:"status-content"},R={class:"status-text"},j={key:0},q={key:1},J={key:2},M={key:3},L={key:4},O={class:"status-icon"},G={class:"trade-hash"},K=A(" \u4EA4\u6613Hash: "),Q={key:0},W=H(()=>n("use",{"xlink:href":"#icon-copy"},null,-1)),X=[W],Y={key:1},Z=H(()=>n("span",null,"N/A",-1)),$=[Z];function tt(e,t,o,f,s,h){const k=c("van-loading"),u=c("van-icon"),_=c("DialogBase");return d(),C(_,{class:"trade-box",visible:o.tradeVisable,"onUpdate:visible":t[2]||(t[2]=l=>o.tradeVisable=l),autoClose:!1,closeable:!1,clickOverlayIsClose:!1,title:"\u4EA4\u6613\u8BE6\u60C5",showConfirmButton:!1,showCancelButton:!1},{default:r(()=>{var l,b;return[n("div",E,[n("div",R,[o.status==0?(d(),m("span",j,"\u53D1\u9001\u4EA4\u6613\u5230\u533A\u5757\u94FE...")):o.status==1?(d(),m("span",q,"\u7B49\u5F85\u670D\u52A1\u5668\u540C\u6B65...")):o.status==2?(d(),m("span",J,"\u4EA4\u6613\u6210\u529F")):o.status==-1?(d(),m("span",M,"\u4E0A\u94FE\u4EA4\u6613\u53D1\u9001\u5931\u8D25")):o.status==-2?(d(),m("span",L,"\u670D\u52A1\u5668\u540C\u6B65\u8D85\u65F6")):V("",!0)]),n("div",O,[o.status==0||o.status==1?(d(),C(k,{key:0,type:"spinner",size:"48px"})):V("",!0),o.status==2?(d(),C(u,{key:1,color:"#07c160",size:"40px",name:"checked"})):V("",!0),o.status==-1||o.status==-2?(d(),C(u,{key:2,color:"#FA5151",size:"40px",name:"clear"})):V("",!0)]),n("div",G,[K,o.status==1||o.status==2||o.status==-2?(d(),m("text",Q,[n("span",{onClick:t[0]||(t[0]=(...v)=>e.jumpToTxDetail&&e.jumpToTxDetail(...v))},y((b=(l=e.$f).formatAddress)==null?void 0:b.call(l,o.tradeHash,6)),1),(d(),m("svg",{class:"icon-svg icon-renzheng","aria-hidden":"true",onClick:t[1]||(t[1]=v=>h.copy(o.tradeHash))},X))])):o.status==0||o.status==-1?(d(),m("text",Y,$)):V("",!0)])])]}),_:1},8,["visible"])}const et=D(z,[["render",tt],["__scopeId","data-v-3fb3f7d6"]]),st="/assets/svg/redPacket/luck.svg",ot="/assets/svg/redPacket/redPacket.svg",at={name:"CreateRedPacket",components:{ChainTrade:et},computed:{totalAmount(){if(this.type=="0")return this.amount?parseInt(this.amount):0;if(this.type=="1")return this.amount&&this.count?parseInt(this.amount)*parseInt(this.count):0}},data(){return{tradeVisable:!1,tradeStatus:0,tradeHash:"",type:"0",result:"",showTokenPicker:!1,count:"",tokenType:["JF"],amount:"",symbol:"JF",remark:"",balance:0,tokenAddress:"0xaf22F677373352761B7F8FAfF4c9aD7bd8B6Be42",contractAddress:"0xad3f6E6d8B3D08Ed7d46988fDb4a324e6F6006C6"}},methods:{onTokenConfirm(e){console.log("onTokenConfirm"),this.balance=0,this.symbol=e,this.showTokenPicker=!1,this.getBalance()},async getBalance(){this.balance=await g.contract.getBalance(this.tokenAddress,this.$store.state.user.userAddress)},async sendRedPacket(){const e=Number(this.amount),t=Number(this.count);if(e<=0){Toast("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E\u7B49\u4E8E0");return}if(t<1){Toast("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E1");return}if(t>this.$store.state.group.totalMembers){Toast("\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC7\u672C\u7FA4\u4EBA\u6570");return}if(Number(this.totalAmount)>this.balance){Toast("\u4F59\u989D\u4E0D\u8DB3");return}this.tradeStatus=0,this.tradeVisable=!0;try{let f=300;if(console.log("\u53D1\u9001\u7EA2\u5305"),!await this.auth())throw"not auth";console.log("auth");const h={_owner:this.$store.state.user.userAddress,token:this.tokenAddress,amount:e,unlockDate:f,quantity:t,kind:this.type};let k=await g.contract.lock(this.contractAddress,h);console.dir(k);let u=await k.wait();this.tradeStatus=1,this.tradeHash=u.transactionHash,this.tradeVisable=!0,console.dir(u);let _=u==null?void 0:u.events,l={};for(let p=_.length-1;p>=0;p--){let B=_[p].topics.some(i=>i==="0x694af1cc8727cdd0afbdd53d9b87b69248bd490224e9dd090e788546506e076f");if(_[p].address==this.contractAddress&&B){l=_[p];break}}let b=l.data.slice(-128,-64);const v=await g.contract.getDecimal(this.tokenAddress),w=await g.contract.getAmount(this.tokenAddress,"0x"+b),x={groupId:this.$route.params.groupId,contractAddress:this.tokenAddress,contractChain:"eth",contractDecimal:v,count:t,endTime:f,redPacketId:l.topics[1],remark:this.remark,singleAmount:e,symbol:this.symbol,totalAmount:Number(this.totalAmount),tx:u.transactionHash,type:Number(this.type)};await g.redPacket.send(x),this.tradeStatus=2,await I(1e3),this.$router.push({name:"Chat",params:{groupId:this.$route.params.groupId}})}catch(f){console.log(f),this.tradeStatus=-1,await I(1e3),this.tradeVisable=!1}},async auth(){let e=await this.allowance();if(!e){const t=await this.approve(this.contractAddress,this.tokenAddress);console.log("approve",t),t&&(e=await this.allowance())}return e},async allowance(){const e=await g.contract.allowanceSend({spender:this.contractAddress,tokenAddress:this.tokenAddress,account:this.$store.state.user.userAddress});return console.log("allowanceSend",e),e}},mounted(){this.getBalance()}},T=e=>(S("data-v-4fb920ff"),e=e(),P(),e),nt={class:"myChats-container"},it={class:"body"},lt=A("\u62FC\u624B\u6C14\u7EA2\u5305"),rt=A("\u666E\u901A\u7EA2\u5305"),dt=T(()=>n("img",{class:"left-icon",src:st,alt:"",srcset:""},null,-1)),ct={class:"right-text"},ut={class:"desc-text margin-bottom"},mt=T(()=>n("img",{class:"left-icon",src:ot,alt:"",srcset:""},null,-1)),ht=T(()=>n("div",{class:"right-text"},"\u4E2A",-1)),_t={class:"desc-text margin-bottom"},pt={class:"total"},ft=A("\u7EA2\u5305\u603B\u989D"),kt={class:"amount"},bt={style:{margin:"16px"}},vt=A(" \u585E\u5E01\u8FDB\u7EA2\u5305 "),gt=T(()=>n("div",{class:"bottom"},"\u672A\u9886\u53D6\u7684\u7EA2\u5305, \u5C06\u572824\u5C0F\u65F6\u540E\u9000",-1));function yt(e,t,o,f,s,h){const k=c("van-nav-bar"),u=c("van-radio"),_=c("van-radio-group"),l=c("van-field"),b=c("van-picker"),v=c("van-popup"),w=c("van-cell-group"),x=c("van-button"),p=c("van-form"),B=c("ChainTrade");return d(),m(U,null,[n("section",nt,[a(k,{fixed:"",placeholder:"","left-arrow":"","safe-area-inset-top":"","z-index":"2",title:"\u521B\u5EFA\u7EA2\u5305",onClickLeft:t[0]||(t[0]=i=>e.$router.push({name:"Chat",params:{groupId:e.$route.params.groupId}}))}),n("div",it,[a(p,{onSubmit:h.sendRedPacket},{default:r(()=>[a(l,{name:"type",class:"red-packet-type"},{input:r(()=>[a(_,{modelValue:s.type,"onUpdate:modelValue":t[1]||(t[1]=i=>s.type=i),direction:"horizontal"},{default:r(()=>[a(u,{"checked-color":"#ED4A4A",name:"0"},{default:r(()=>[lt]),_:1}),a(u,{"checked-color":"#ED4A4A",name:"1"},{default:r(()=>[rt]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(w,{inset:"",class:"margin-bottom"},{default:r(()=>[a(l,{modelValue:s.symbol,"onUpdate:modelValue":t[2]||(t[2]=i=>s.symbol=i),"is-link":"",readonly:"",name:"picker",label:"\u5E01\u79CD",placeholder:"\u70B9\u51FB\u9009\u62E9\u5E01\u79CD",onClick:t[3]||(t[3]=i=>s.showTokenPicker=!0),"input-align":"right"},null,8,["modelValue"]),a(v,{show:s.showTokenPicker,"onUpdate:show":t[5]||(t[5]=i=>s.showTokenPicker=i),position:"bottom"},{default:r(()=>[a(b,{columns:s.tokenType,onCancel:t[4]||(t[4]=i=>s.showTokenPicker=!1),onConfirm:h.onTokenConfirm},null,8,["columns","onConfirm"])]),_:1},8,["show"])]),_:1}),a(w,{inset:""},{default:r(()=>[a(l,{label:"\u91D1\u989D",class:"ipt-num"},{"left-icon":r(()=>[dt]),input:r(()=>[a(l,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":t[6]||(t[6]=i=>s.amount=i),type:"number",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u91D1\u989D"}]},null,8,["modelValue"]),n("div",ct,y(s.symbol),1)]),_:1})]),_:1}),n("div",ut,"\u53EF\u7528\u4F59\u989D "+y((s.balance?s.balance:"--")+" "+s.symbol),1),a(w,{inset:""},{default:r(()=>[a(l,{label:"\u7EA2\u5305\u4E2A\u6570",class:"ipt-num"},{"left-icon":r(()=>[mt]),input:r(()=>[a(l,{"input-align":"right",modelValue:s.count,"onUpdate:modelValue":t[7]||(t[7]=i=>s.count=i),type:"digit",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u7EA2\u5305\u4E2A\u6570"}]},null,8,["modelValue"]),ht]),_:1})]),_:1}),n("div",_t,"\u672C\u7FA4\u5171 "+y(e.$store.state.group.totalMembers)+" \u4EBA",1),a(w,{inset:""},{default:r(()=>[a(l,{modelValue:s.remark,"onUpdate:modelValue":t[8]||(t[8]=i=>s.remark=i),rows:"3",autosize:"",placeholder:"\u606D\u559C\u53D1\u8D22\uFF0C\u9886\u53D6\u7A7A\u6295",type:"textarea",maxlength:"32"},null,8,["modelValue"])]),_:1}),n("div",pt,[ft,n("span",kt,y(h.totalAmount?h.totalAmount:"--"),1),A(y(s.symbol),1)]),n("div",bt,[a(x,{round:"",block:"",type:"default","native-type":"submit"},{default:r(()=>[vt]),_:1})])]),_:1},8,["onSubmit"]),gt])]),a(B,{tradeVisable:s.tradeVisable,"onUpdate:tradeVisable":t[9]||(t[9]=i=>s.tradeVisable=i),status:s.tradeStatus,tradeHash:s.tradeHash},null,8,["tradeVisable","status","tradeHash"])],64)}const wt=D(at,[["render",yt],["__scopeId","data-v-4fb920ff"]]);export{wt as default};
