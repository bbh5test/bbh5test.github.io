import{C as H,R as Y}from"./chatItem.38d5f375.js";import{_ as B,o as c,d as p,b as r,m as n,t as m,r as l,k,T as _,w as a,f as g,F as w,e as C,q as N,a as v,u as O,v as R,x as D,D as V,s as A,y as F,p as z,g as j}from"./index.7651113b.js";import{D as G}from"./dialogBase.d68ddd56.js";import{A as J}from"./avatar.766fe2de.js";import"./roleTag.5aa9d426.js";const q={name:"ChatNotice",props:{content:{type:String,default:""}},emits:["onClose","onPinedClick"],computed:{},methods:{onClose(){this.$emit("onClose")},onPinedClick(){this.$emit("onPinedClick")}}},K={class:"chat-notice"},Q={class:"icon-box"};function W(t,e,d,b,o,s){const u=l("van-icon");return c(),p("div",K,[r("div",Q,[n(u,{class:"icon",size:"24px",name:"/assets/images/horn.png"})]),r("div",{class:"text",onClick:e[0]||(e[0]=(...f)=>s.onPinedClick&&s.onPinedClick(...f))},m(d.content),1),r("div",{class:"icon-box",onClick:e[1]||(e[1]=(...f)=>s.onClose&&s.onClose(...f))},[n(u,{class:"icon close",size:"24px",name:"cross"})])])}const X=B(q,[["render",W],["__scopeId","data-v-bf332d48"]]);const Z={name:"ChatBar",props:{reply:{type:Object,default:null}},emits:["chatBarToolClick","onFocus"],data(){return{text:"",lastSendTime:0,slowSendTimer:0,sendCountdown:"",showTools:!1,sendLoading:!1}},computed:{toolList(){let t=[{key:"redPacket",icon:"/assets/images/redPacketRed.png",text:this.$t("redPacket")}];return this.$store.state.group.nftMintUrl&&t.push({key:"mintNft",icon:"/assets/images/nftMint.png",text:this.$t("mintNft")}),this.$store.state.group.nftTradeUrl&&t.push({key:"tradeNft",icon:"/assets/images/nftTrade.png",text:this.$t("tradeNft")}),t},status(){if(this.$store.state.group.isJoined){if(this.$store.state.group.status==0&&this.$store.state.group.currentUser.status==0)return 0;if(this.$store.state.group.status==1||this.$store.state.group.currentUser.status==1)return 1;if(this.$store.state.group.status==2||this.$store.state.group.currentUser.status==2)return 2;if(this.$store.state.group.status==3||this.$store.state.group.currentUser.status==3)return 3}else return-1;return-2},bannedExpiredTime(){return this.$store.state.group.status==1?this.$dayjs.unix(this.$store.state.group.bannedExpiredTime).format("YYYY-MM-DD HH:mm:ss"):this.$dayjs.unix(this.$store.state.group.currentUser.bannedExpiredTime).format("YYYY-MM-DD HH:mm:ss")},replyItem:{get(){return this.reply},set(t){this.$emit("update:reply",t)}},inputPlaceholder(){return this.$store.state.group.tokenPrice.price?`${this.$t("messagePlaceholder")} | $${this.$store.state.group.tokenPrice.price.toFixed(1)}  ${this.$store.state.group.tokenPrice.direction=="up"?"+":""}${this.$store.state.group.tokenPrice.priceChange}%`:this.$t("messagePlaceholder")},inputPlaceholderColor(){return this.$store.state.group.tokenPrice.price?this.$store.state.group.tokenPrice.direction=="up"?"token-price-up":"token-price-down":""}},methods:{focus(){this.showTools=!1,this.$emit("onFocus")},async onSend(){if(!!this.text.trim()){this.sendLoading=!0;try{(await k.group.sendMsg(this.text,this.$store.state.group.groupId,this.replyItem?this.replyItem.toId:0,1)).status==1&&(this.replyItem=null,this.text="",this.showTools=!1,this.lastSendTime=parseInt(new Date().getTime()/1e3))}catch(t){console.log(t),_("Send Message Error")}finally{this.sendLoading=!1}this.status==3&&(this.sendCountdown=this.calcCountdown(30),this.slowSendTimer=setInterval(()=>{let e=parseInt(new Date().getTime()/1e3),d=this.lastSendTime+30-e;d>0?this.sendCountdown=this.calcCountdown(d):(clearInterval(this.slowSendTimer),this.slowSendTimer=0,this.sendCountdown="")},1e3))}},calcCountdown(t){let e=parseInt(t/60),d=t%60;return e>0?e+":"+(d+"").padStart(2,"0"):d+""},onJoin(){this.$store.dispatch("joinGroup",this.$store.state.group.groupId)},onChatBarToolClick(t){this.$emit("chatBarToolClick",t)}}},ee={class:"chat-bar"},te={key:0,class:"action-btn"},se={key:0,class:"reply"},oe={class:"icon-box"},ne={class:"reply-info"},ie={class:"to"},re={class:"to-name"},ae={class:"msg"},le={class:"action"},de={class:"tools"},ce={key:2,class:"action-btn"},ue={key:3,class:"action-btn"},he=g("\u6C38\u4E45\u7981\u8A00");function pe(t,e,d,b,o,s){const u=l("van-button"),f=l("van-icon"),T=l("van-field"),x=l("van-grid-item"),$=l("van-grid");return c(),p("div",ee,[s.status==-1?(c(),p("div",te,[n(u,{class:"join",type:"default",round:"",block:"",onClick:s.onJoin},{default:a(()=>[g(m(t.$t("join")),1)]),_:1},8,["onClick"])])):s.status==0||s.status==3?(c(),p(w,{key:1},[s.replyItem?(c(),p("div",se,[r("div",oe,[n(f,{class:"icon",size:"24px",name:"/assets/images/reply.png"})]),r("div",ne,[r("div",ie,[g(m(t.$t("reply")),1),r("span",re,m(s.replyItem.toName),1)]),r("div",ae,m(s.replyItem.toMsg),1)]),r("div",{class:"icon-box",onClick:e[0]||(e[0]=h=>d.reply=null)},[n(f,{class:"icon close",size:"24px",name:"cross"})])])):C("",!0),r("div",le,[n(u,{class:"btn",icon:"/assets/images/add.png",onClick:e[1]||(e[1]=h=>o.showTools=!o.showTools)}),n(T,{class:N(["input",s.inputPlaceholderColor]),onFocus:s.focus,modelValue:o.text,"onUpdate:modelValue":e[2]||(e[2]=h=>o.text=h),placeholder:s.inputPlaceholder,type:"textarea",rows:"1",autosize:{maxHeight:100},maxlength:"4096"},null,8,["class","onFocus","modelValue","placeholder"]),s.status==3&&o.sendCountdown?(c(),v(u,{key:0,class:"btn",disabled:""},{default:a(()=>[g(m(o.sendCountdown),1)]),_:1})):(c(),v(u,{key:1,class:"btn",icon:"/assets/images/send.png",onClick:s.onSend,loading:o.sendLoading},null,8,["onClick","loading"]))]),O(r("div",de,[n($,{"column-num":4,"icon-size":"54px",border:!1},{default:a(()=>[(c(!0),p(w,null,D(s.toolList,h=>(c(),v(x,{key:h.key,icon:h.icon,text:h.text,onClick:U=>t.$emit("chatBarToolClick",h.key)},null,8,["icon","text","onClick"]))),128))]),_:1})],512),[[R,o.showTools]])],64)):s.status==1?(c(),p("div",ce,[n(u,{type:"default",disabled:"",round:"",block:""},{default:a(()=>[g("\u7981\u8A00\u4E2D, \u89E3\u7981\u65F6\u95F4"+m(s.bannedExpiredTime),1)]),_:1})])):s.status==2?(c(),p("div",ue,[n(u,{type:"default",disabled:"",round:"",block:""},{default:a(()=>[he]),_:1})])):C("",!0)])}const me=B(Z,[["render",pe],["__scopeId","data-v-eede7db3"]]);const ge={name:"Chat",components:{ChatItem:H,ChatNotice:X,DialogBase:G,RedPacket:Y,ChatBar:me,Avatar:J},data(){return{listLoading:!1,listFinished:!1,banVisable:!1,banChecked:"2",banUserAddress:"",selectBanExpiredVisable:!1,banExpired:new Date,banMinTime:new Date,removeVisable:!1,removeChecked:"1",removeUserAddress:"",pinedVisible:!0,reply:null,offset:0,containerHeight:"100vh"}},computed:{group(){return this.$store.state.group},groupTitle(){return this.$f.getGroupShowName({address:this.group.groupId.split("-")[0],name:this.group.name,nickname:this.group.nickname})}},watch:{"$store.state.ws.status"(t){let e;t==1?e=_.loading({message:"Loading...",forbidClick:!0}):e&&e.clear()},"$store.state.group.msgList.length":{handler(t,e){this.$refs.rightBody.scrollTop+this.$refs.rightBody.clientHeight==this.$refs.rightBody.scrollHeight&&this.scrollToBottom()},deep:!0},"$store.state.group.status"(t){switch(t){case 1:_("\u8BE5\u7FA4\u5DF2\u88AB\u7981\u8A00\u5904\u7F5A\u81F3"+this.$dayjs.unix(this.$store.state.group.bannedExpired).format("YYYY-MM-DD HH:mm:ss"));break;case 2:_("\u8BE5\u7FA4\u5DF2\u88AB\u6C38\u4E45\u7981\u8A00\u5904\u7F5A");break;case 3:_("\u8BE5\u7FA4\u5DF2\u88AB\u6162\u901F\u53D1\u8A00\u5904\u7F5A,\u53D1\u8A00\u95F4\u969430\u79D2");break;case 4:V.alert({title:"\u63D0\u793A",message:"\u8BE5\u7FA4\u5DF2\u88AB\u5C01\u7981"}).then(()=>{this.$router.push("/chats")});break}},"$store.state.group.currentUser.status"(t){switch(t){case 5:V.alert({title:"\u63D0\u793A",message:"\u60A8\u5DF2\u88AB\u8E22\u51FA\u7FA4\u804A"}).then(()=>{this.$router.push("/chats")});break}}},methods:{onLoad(){this.offset=-999999,this.loadLastPage()},async loadLastPage(){this.$refs.rightBody.querySelectorAll(".van-cell")[0];let t=-1;this.$store.state.group.msgList.length>0&&(t=this.$store.state.group.msgList[0].id);try{let e=await k.group.getMsgList(this.$store.state.group.groupId,10,t);if(e.status==1){if(e.data.length>0)for(let d=e.data.length-1;d>=0;d--)this.$store.commit("addMsgUnshift",e.data[d]);e.data.length<10&&(this.listFinished=!0)}}catch{}finally{this.$nextTick(()=>{this.listLoading=!1,this.$nextTick(async()=>{await A(500),this.$refs.rightBody.scrollTop=1,this.offset=0})})}},onBanUser(t){this.banMinTime=new Date;let e=new Date;this.banExpired=new Date(e.setDate(e.getDate()+1)),this.banUserAddress=t,this.banVisable=!0},clickSelectBanExpired(){this.banChecked="1",this.selectBanExpiredVisable=!0},async banConfirm(){let t=0;this.banChecked=="1"&&(t=this.$dayjs(this.banExpired).unix()),(await k.groupMember.banMember(this.group.groupId,this.banUserAddress,parseInt(this.banChecked),t)).status==1&&_.success("\u7981\u8A00\u7528\u6237\u6210\u529F"),this.banUserAddress=""},onRemoveUser(t){this.removeUserAddress=t,this.removeVisable=!0},async removeConfirm(){this.removeChecked=="2"?(await k.user.blockUser(this.removeUserAddress)).status==1&&_.success("\u8E22\u51FA\u7528\u6237\u6210\u529F"):(await k.groupMember.removeMember(this.group.groupId,this.removeUserAddress)).status==1&&_.success("\u8E22\u51FA\u7528\u6237\u6210\u529F"),this.removeUserAddress=""},onReply(t){this.reply={toId:t.id,toName:this.$f.getUserShowName(t),toMsg:t.content}},onPinedClick(){this.$router.push("/group/"+this.$route.params.groupId+"/pined")},toChats(){this.$router.push("/chats")},toGroupDetail(){this.$router.push("/group/"+this.$route.params.groupId+"/detail")},onChatBarToolClick(t){switch(t){case"redPacket":this.$router.push("/group/"+this.$route.params.groupId+"/createRedPacket");break;case"mintNft":window.open(this.$store.state.group.nftMintUrl);break;case"tradeNft":window.open(this.$store.state.group.nftTradeUrl);break}},scrollToBottom(){this.$nextTick(()=>{this.$refs.rightBody.scrollTop=this.$refs.rightBody.scrollHeight}),this.scrollTop=this.$refs.rightBody.scrollHeight},addMsgUnshift(t){this.msgList.unshift(t),this.formatMsgList()},formatMsgList(){let t="";for(let e of this.msgList)if(e.type==6)e.redPacket=JSON.parse(e.content);else if(e.type==1){let d=this.$dayjs.unix(e.sendTime),b=d.format("YYYY-MM-DD");t!=b?(e.showSendTime=d.format("YYYY-MM-DD HH:mm"),t=b):e.showSendTime=d.format("HH:mm")}},chagneContainerHeight(){this.containerHeight=document.documentElement.clientHeight+"px"}},mounted(){this.$store.state.group.scrollTop==-1?this.scrollToBottom():this.$refs.rightBody.scrollTop=this.$store.state.group.scrollTop,this.$nextTick(()=>{this.chagneContainerHeight(),window.addEventListener("resize",this.chagneContainerHeight)})},unmounted(){window.removeEventListener("resize",this.chagneContainerHeight)},beforeRouteLeave(t,e){this.scrollTop=this.$refs.rightBody.scrollTop,this.$store.commit("setScrollTop",this.$refs.rightBody.scrollTop)}},fe=t=>(z("data-v-31323840"),t=t(),j(),t),_e={ref:"header"},ve={class:"nav-bar"},be={class:"info"},ke={class:"title-line"},Ce={class:"title"},ye={class:"desc"},we=fe(()=>r("i",{class:"iconfont icon-set"},null,-1)),Te={class:"chat-content",ref:"rightBody"},xe=g("\u8E22\u51FA\u5F53\u524D\u7FA4\u804A\u53CA\u5220\u9664\u6240\u6709\u6D88\u606F"),$e=g("\u8E22\u51FA Ta \u7684\u6240\u6709\u7FA4\u804A\u53CA\u5220\u9664\u6240\u6709\u6D88\u606F"),Be=g("\u6C38\u4E45\u7981\u8A00"),Ue=g("\u7981\u8A00\u81F3");function Ie(t,e,d,b,o,s){var L;const u=l("van-icon"),f=l("Avatar"),T=l("van-nav-bar"),x=l("ChatNotice"),$=l("ChatItem"),h=l("van-cell"),U=l("van-list"),P=l("ChatBar"),y=l("van-radio"),I=l("van-radio-group"),M=l("DialogBase"),S=l("van-datetime-picker"),E=l("van-popup");return c(),p(w,null,[r("section",{class:"chat-container",style:F({height:o.containerHeight})},[r("div",_e,[n(T,{fixed:"",placeholder:"","safe-area-inset-top":"",onClickLeft:s.toChats,onClickRight:s.toGroupDetail},{left:a(()=>[n(u,{name:"wap-nav"})]),title:a(()=>[r("div",ve,[s.group.groupId?(c(),v(f,{key:0,class:"avatar",image:s.group.image?s.group.image:t.$f.formatIcon(t.$route.params.groupId),address:s.group.address},null,8,["image","address"])):C("",!0),r("div",be,[r("div",ke,[r("div",Ce,m(s.groupTitle),1),t.$store.state.group.providers&&t.$store.state.group.providers.length>0?(c(),v(u,{key:0,size:"0.4rem",name:"/assets/images/certification.png"})):C("",!0)]),r("div",ye,m(`${s.group.totalMembers} ${t.$t("members")}`),1)])])]),right:a(()=>[we]),_:1},8,["onClickLeft","onClickRight"]),((L=s.group.pinedMsgList)==null?void 0:L.length)>0&&o.pinedVisible?(c(),v(x,{key:0,onOnClose:e[0]||(e[0]=i=>o.pinedVisible=!1),content:s.group.pinedMsgList[s.group.pinedMsgList.length-1].content,onOnPinedClick:s.onPinedClick},null,8,["content","onOnPinedClick"])):C("",!0)],512),r("div",Te,[n(U,{loading:o.listLoading,"onUpdate:loading":e[1]||(e[1]=i=>o.listLoading=i),class:"chat-list",direction:"up",onLoad:s.onLoad,"immediate-check":!1,finished:o.listFinished,"loading-text":t.$t("loading"),offset:o.offset},{default:a(()=>[(c(!0),p(w,null,D(s.group.msgList,i=>(c(),v(h,{key:i.id},{default:a(()=>[n($,{source:i,onOnReply:Me=>s.onReply(i),onOnRemoveUser:s.onRemoveUser,onOnBanUser:s.onBanUser},null,8,["source","onOnReply","onOnRemoveUser","onOnBanUser"])]),_:2},1024))),128))]),_:1},8,["loading","onLoad","finished","loading-text","offset"])],512),n(P,{reply:o.reply,"onUpdate:reply":e[2]||(e[2]=i=>o.reply=i),onChatBarToolClick:s.onChatBarToolClick,onOnFocus:s.scrollToBottom},null,8,["reply","onChatBarToolClick","onOnFocus"])],4),n(M,{visible:o.removeVisable,"onUpdate:visible":e[4]||(e[4]=i=>o.removeVisable=i),title:"\u8E22\u51FA\u7FA4\u804A",showConfirmButton:!0,showCancelButton:!0,onOnConfirm:s.removeConfirm},{default:a(()=>[n(I,{modelValue:o.removeChecked,"onUpdate:modelValue":e[3]||(e[3]=i=>o.removeChecked=i)},{default:a(()=>[n(y,{name:"1"},{default:a(()=>[xe]),_:1}),n(y,{name:"2"},{default:a(()=>[$e]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["visible","onOnConfirm"]),n(M,{visible:o.banVisable,"onUpdate:visible":e[11]||(e[11]=i=>o.banVisable=i),title:"\u7981\u8A00\u65F6\u6548\u8BBE\u7F6E",showConfirmButton:!0,showCancelButton:!0,onOnConfirm:s.banConfirm},{default:a(()=>[n(I,{modelValue:o.banChecked,"onUpdate:modelValue":e[10]||(e[10]=i=>o.banChecked=i)},{default:a(()=>[n(y,{name:"2"},{default:a(()=>[Be]),_:1}),n(y,{name:"1"},{default:a(()=>[Ue]),_:1}),r("div",{class:"ban-date-time",onClick:e[5]||(e[5]=(...i)=>s.clickSelectBanExpired&&s.clickSelectBanExpired(...i))},m(t.$dayjs(o.banExpired).format("YYYY-MM-DD HH:mm:ss")),1),n(E,{show:o.selectBanExpiredVisable,"onUpdate:show":e[9]||(e[9]=i=>o.selectBanExpiredVisable=i),teleport:"#app",position:"bottom"},{default:a(()=>[n(S,{modelValue:o.banExpired,"onUpdate:modelValue":e[6]||(e[6]=i=>o.banExpired=i),type:"datetime","min-date":o.banMinTime,onCancel:e[7]||(e[7]=i=>o.selectBanExpiredVisable=!1),onConfirm:e[8]||(e[8]=i=>o.selectBanExpiredVisable=!1)},null,8,["modelValue","min-date"])]),_:1},8,["show"])]),_:1},8,["modelValue"])]),_:1},8,["visible","onOnConfirm"])],64)}const Ee=B(ge,[["render",Ie],["__scopeId","data-v-31323840"]]);export{Ee as default};
