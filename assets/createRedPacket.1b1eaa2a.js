import{D as R}from"./dialogBase.ebd095b0.js";import{_ as P,c as E,o as u,a as y,w as l,b as r,d as k,t as d,e as $,f as v,r as h,p as B,g as N,k as p,s as D,T as b,ag as F,m as i,F as I,x as q}from"./index.66eb9546.js";const M={name:"ChainTrade",components:{DialogBase:R},props:{tradeVisable:{type:Boolean,default:!1},status:{type:Number,default:0},tradeHash:{type:String,default:""}},emits:["update:tradeVisable"],methods:{copy:E}},H=e=>(B("data-v-a156f7ea"),e=e(),N(),e),j={class:"status-content"},W={class:"status-text"},J={key:0},K={key:1},O={key:2},G={key:3},Q={key:4},X={class:"status-icon"},Y={class:"trade-hash"},Z={key:0},ee=H(()=>r("use",{"xlink:href":"#icon-copy"},null,-1)),te=[ee],se={key:1},ae=H(()=>r("span",null,"N/A",-1)),ne=[ae];function oe(e,t,o,A,s,m){const f=h("van-loading"),a=h("van-icon"),_=h("DialogBase");return u(),y(_,{class:"trade-box",visible:o.tradeVisable,"onUpdate:visible":t[2]||(t[2]=c=>o.tradeVisable=c),autoClose:!1,closeable:!1,clickOverlayIsClose:!1,title:e.$t("transactionDetails"),showConfirmButton:!1,showCancelButton:!1},{default:l(()=>[r("div",j,[r("div",W,[o.status==0?(u(),k("span",J,d(e.$t("sendingTransactionToBlockchain")),1)):o.status==1?(u(),k("span",K,d(e.$t("waitingForServiceSyncronizing")),1)):o.status==2?(u(),k("span",O,d(e.$t("transactionSuccess")),1)):o.status==-1?(u(),k("span",G,d(e.$t("sendTransactionToBlockchainFailed")),1)):o.status==-2?(u(),k("span",Q,d(e.$t("servicesyncronizingTimeout")),1)):$("",!0)]),r("div",X,[o.status==0||o.status==1?(u(),y(f,{key:0,type:"spinner",size:"48px"})):$("",!0),o.status==2?(u(),y(a,{key:1,color:"#07c160",size:"40px",name:"checked"})):$("",!0),o.status==-1||o.status==-2?(u(),y(a,{key:2,color:"#FA5151",size:"40px",name:"clear"})):$("",!0)]),r("div",Y,[v(d(e.$t("txHash")+":")+" ",1),o.status==1||o.status==2||o.status==-2?(u(),k("text",Z,[r("span",{onClick:t[0]||(t[0]=(...c)=>e.jumpToTxDetail&&e.jumpToTxDetail(...c))},d(e.$f.formatAddress(o.tradeHash,6)),1),(u(),k("svg",{class:"icon-svg icon-renzheng","aria-hidden":"true",onClick:t[1]||(t[1]=c=>m.copy(o.tradeHash))},te))])):o.status==0||o.status==-1?(u(),k("text",se,ne)):$("",!0)])])]),_:1},8,["visible","title"])}const ie=P(M,[["render",oe],["__scopeId","data-v-a156f7ea"]]),le="/assets/svg/redPacket/luck.svg",re="/assets/svg/redPacket/redPacket.svg";const de={name:"CreateRedPacket",components:{ChainTrade:ie},computed:{totalAmount(){if(this.type=="0")return this.amount?parseInt(this.amount):0;if(this.type=="1")return this.amount&&this.count?parseInt(this.amount)*parseInt(this.count):0}},data(){return{tradeVisable:!1,tradeStatus:0,tradeHash:"",type:"0",result:"",showTokenSelect:!1,count:"",amount:"",symbol:"",showDeadlinePicker:!1,deadlineList:[{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},{text:this.$t("deadlineList.600"),value:600,showText:this.$t("deadlineList.600Show")},{text:this.$t("deadlineList.1800"),value:1800,showText:this.$t("deadlineList.1800Show")},{text:this.$t("deadlineList.3600"),value:3600,showText:this.$t("deadlineList.3600Show")},{text:this.$t("deadlineList.43200"),value:43200,showText:this.$t("deadlineList.43200Show")},{text:this.$t("deadlineList.86400"),value:86400,showText:this.$t("deadlineList.86400Show")}],deadline:{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},remark:"",tokenAddress:"",contractAddress:"0xad3f6E6d8B3D08Ed7d46988fDb4a324e6F6006C6",tokenList:[],balance:-1,needApprove:!1}},methods:{async approve(){this.tradeStatus=0,this.tradeVisable=!0,this.tradeHash="";try{const e=await p.contract.approve(this.contractAddress,this.tokenAddress);console.log("approve",e),e?(this.tradeHash=e.hash,this.tradeStatus=1,await e.wait(),this.tradeStatus=2,this.needApprove=!1):this.tradeStatus=-1}catch{this.tradeStatus=-1}finally{await D(1e3),this.tradeVisable=!1}},async selectToken(e){this.showTokenSelect=!1,this.tokenAddress=e.address,this.symbol=e.symbol,this.balance=-1;let t=b.loading();await this.getBalance();const o=await this.allowance();this.needApprove=!o,t.clear()},async getTokenList(){this.tokenList=[];const e=this.$store.state.user.userAddress,t=this.$store.state.chainId;if(t==4){this.tokenList=[{address:"0xaf22f677373352761b7f8faff4c9ad7bd8b6be42",tokenId:"0xaf22f677373352761b7f8faff4c9ad7bd8b6be42-eth",chain:"eth",symbol:"JF",decimals:18,image:"/assets/images/groupAvatar.png",amount:0}];return}const o=b.loading();let s=(await p.user.getUserTokenList(e,F[t])).data.filter(a=>new RegExp("^0x.*$","gi").test(a.id)).map(a=>({address:a.id.toLowerCase(),tokenId:`${a.id}-${a.chain}`.toLowerCase(),chain:a.chain.toLowerCase(),symbol:a.symbol,decimals:a.decimals,image:a.logo_url,amount:a.amount})),m=s.map(a=>a.tokenId),f=await p.redPacket.tokenlistcheck(m);this.tokenList=s.filter(a=>f.data[a.tokenId].riskScore<60),o.clear()},onDeadlineConfirm(e){this.deadline=e,this.showDeadlinePicker=!1},async getBalance(){try{this.balance=await p.contract.getBalance(this.tokenAddress,this.$store.state.user.userAddress)}catch(e){console.log(e),this.$store.state.wallet=="WalletConnect"&&await this.$store.state.provider.disconnect(),this.$store.commit("logout")}},async sendRedPacket(){const e=Number(this.amount),t=Number(this.count);if(!this.tokenAddress){b("\u8BF7\u5148\u9009\u62E9\u4EE3\u5E01");return}if(e<=0){b("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E\u7B49\u4E8E0");return}if(t<1){b("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E1");return}if(t>this.$store.state.group.totalMembers){b("\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC7\u672C\u7FA4\u4EBA\u6570");return}if(Number(this.totalAmount)>this.balance){b("\u4F59\u989D\u4E0D\u8DB3");return}let A=this.deadline.value;if(!await this.allowance()){this.needApprove=!0,b("need approve");return}this.tradeStatus=0,this.tradeVisable=!0;try{console.log("\u53D1\u9001\u7EA2\u5305");const m={_owner:this.$store.state.user.userAddress,token:this.tokenAddress,amount:e,unlockDate:A,quantity:t,kind:this.type};let f=await p.contract.lock(this.contractAddress,m);console.dir(f);let a=await f.wait();this.tradeStatus=1,this.tradeHash=a.transactionHash,this.tradeVisable=!0,console.dir(a);let _=a==null?void 0:a.events,c={};for(let w=_.length-1;w>=0;w--){let L=_[w].topics.some(T=>T==="0x694af1cc8727cdd0afbdd53d9b87b69248bd490224e9dd090e788546506e076f");if(_[w].address==this.contractAddress&&L){c=_[w];break}}let C=c.data.slice(-128,-64);const V=await p.contract.getDecimal(this.tokenAddress),g=await p.contract.getAmount(this.tokenAddress,"0x"+C),S={groupId:this.$route.params.groupId,contractAddress:this.tokenAddress,contractChain:"eth",contractDecimal:V,count:t,endTime:A,redPacketId:c.topics[1],remark:this.remark,singleAmount:e,symbol:this.symbol,totalAmount:Number(this.totalAmount),tx:a.transactionHash,type:Number(this.type)};await p.redPacket.send(S),this.tradeStatus=2,await D(1e3),this.$router.push({name:"Chat",params:{groupId:this.$route.params.groupId}})}catch(m){console.log(m),this.tradeStatus=-1,await D(1e3),this.tradeVisable=!1}},async auth(){let e=await this.allowance();if(!e){const t=await p.contract.approve(this.contractAddress,this.tokenAddress);console.log("approve",t),t&&(e=await this.allowance())}return e},async allowance(){return await p.contract.allowanceSend({spender:this.contractAddress,tokenAddress:this.tokenAddress,account:this.$store.state.user.userAddress})}},mounted(){this.getTokenList()}},x=e=>(B("data-v-1b68c776"),e=e(),N(),e),ce={class:"myChats-container"},ue={class:"body"},he={class:"token"},me={class:"token-symbol"},pe=v("\xA0\xA0 "),ke=x(()=>r("img",{class:"left-icon",src:le,alt:"",srcset:""},null,-1)),fe={class:"desc-text margin-bottom"},_e=x(()=>r("img",{class:"left-icon",src:re,alt:"",srcset:""},null,-1)),be={class:"desc-text margin-bottom"},ve={class:"total"},ge={class:"amount"},we={style:{margin:"16px"}},ye=v("Approve"),Ae={class:"bottom"};function $e(e,t,o,A,s,m){const f=h("van-nav-bar"),a=h("van-radio"),_=h("van-radio-group"),c=h("van-field"),C=h("van-image"),V=h("van-cell"),g=h("van-cell-group"),S=h("van-action-sheet"),w=h("van-picker"),L=h("van-popup"),T=h("van-button"),U=h("van-form"),z=h("ChainTrade");return u(),k(I,null,[r("section",ce,[i(f,{fixed:"","left-arrow":"","safe-area-inset-top":"","z-index":"2",title:e.$t("createRedPacket"),onClickLeft:t[0]||(t[0]=n=>e.$router.push({name:"Chat",params:{groupId:e.$route.params.groupId}}))},null,8,["title"]),r("div",ue,[i(U,null,{default:l(()=>[i(c,{name:"type",class:"red-packet-type"},{input:l(()=>[i(_,{modelValue:s.type,"onUpdate:modelValue":t[1]||(t[1]=n=>s.type=n),direction:"horizontal"},{default:l(()=>[i(a,{"checked-color":"#ED4A4A",name:"0"},{default:l(()=>[v(d(e.$t("randomAmount")),1)]),_:1}),i(a,{"checked-color":"#ED4A4A",name:"1"},{default:l(()=>[v(d(e.$t("identicalAmount")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(g,{inset:"",class:"margin-bottom"},{default:l(()=>[i(c,{modelValue:s.symbol,"onUpdate:modelValue":t[2]||(t[2]=n=>s.symbol=n),"is-link":"",readonly:"",name:"picker",label:e.$t("token"),onClick:t[3]||(t[3]=n=>s.showTokenSelect=!0),"input-align":"right"},null,8,["modelValue","label"]),i(S,{show:s.showTokenSelect,"onUpdate:show":t[4]||(t[4]=n=>s.showTokenSelect=n),title:e.$t("settingToken")},{default:l(()=>[r("div",he,[i(g,{inset:""},{default:l(()=>[(u(!0),k(I,null,q(s.tokenList,n=>(u(),y(V,{key:n.address,clickable:"",onClick:Te=>m.selectToken(n)},{title:l(()=>[r("div",me,[i(C,{class:"symbol-icon",round:"",width:"0.4rem",height:"0.4rem","icon-size":"0.4rem","lazy-load":"","show-loading":"",src:n.image,"error-icon":"/assets/images/groupAvatar.png"},null,8,["src"]),r("span",null,d(n.symbol),1)])]),value:l(()=>[r("div",null,[r("span",null,d(e.$t("balance"))+": "+d(e.$f.formatNumUnit(n.amount)),1),pe])]),_:2},1032,["onClick"]))),128))]),_:1})])]),_:1},8,["show","title"])]),_:1}),i(g,{inset:""},{default:l(()=>[i(c,{label:e.$t("amount"),class:"ipt-num"},{"left-icon":l(()=>[ke]),input:l(()=>[i(c,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":t[5]||(t[5]=n=>s.amount=n),type:"number","error-message-align":"right",rules:[{required:!0,message:e.$t("enterAmount")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1}),r("div",fe,d(`${e.$t("availableBalance")} ${s.balance>0?s.balance:"--"} ${s.symbol} `),1),i(g,{inset:""},{default:l(()=>[i(c,{label:e.$t("quantity"),class:"ipt-num"},{"left-icon":l(()=>[_e]),input:l(()=>[i(c,{"input-align":"right",modelValue:s.count,"onUpdate:modelValue":t[6]||(t[6]=n=>s.count=n),type:"digit","error-message-align":"right",rules:[{required:!0,message:e.$t("enterNumber")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1}),r("div",be,d(`${e.$t("totalMembers1")} ${e.$store.state.group.totalMembers} ${e.$t("totalMembers2")}`),1),i(g,{inset:"",class:"margin-bottom"},{default:l(()=>[i(c,{modelValue:s.deadline.text,"onUpdate:modelValue":t[7]||(t[7]=n=>s.deadline.text=n),"is-link":"",readonly:"",name:"picker",label:e.$t("deadline"),onClick:t[8]||(t[8]=n=>s.showDeadlinePicker=!0),"input-align":"right"},null,8,["modelValue","label"]),i(L,{show:s.showDeadlinePicker,"onUpdate:show":t[10]||(t[10]=n=>s.showDeadlinePicker=n),position:"bottom"},{default:l(()=>[i(w,{columns:s.deadlineList,onCancel:t[9]||(t[9]=n=>s.showDeadlinePicker=!1),onConfirm:m.onDeadlineConfirm,title:e.$t("settingDeadline"),"confirm-button-text":e.$t("confirm"),"cancel-button-text":e.$t("cancel")},null,8,["columns","onConfirm","title","confirm-button-text","cancel-button-text"])]),_:1},8,["show"])]),_:1}),i(g,{inset:""},{default:l(()=>[i(c,{modelValue:s.remark,"onUpdate:modelValue":t[11]||(t[11]=n=>s.remark=n),rows:"2",autosize:"",placeholder:e.$t("bestWishes"),type:"textarea",maxlength:"20","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1}),r("div",ve,[v(d(e.$t("totalAmount")),1),r("span",ge,d(m.totalAmount?m.totalAmount:"--"),1),v(d(s.symbol),1)]),r("div",we,[s.needApprove?(u(),y(T,{key:0,round:"",block:"",type:"default","native-type":"submit",onClick:m.approve},{default:l(()=>[ye]),_:1},8,["onClick"])):(u(),y(T,{key:1,round:"",block:"",type:"default","native-type":"submit",onClick:m.sendRedPacket},{default:l(()=>[v(d(e.$t("send")),1)]),_:1},8,["onClick"]))])]),_:1}),r("div",Ae,d(`${e.$t("createRedPacketTips1")} ${s.deadline.showText} ${e.$t("createRedPacketTips2")}`),1)])]),i(z,{tradeVisable:s.tradeVisable,"onUpdate:tradeVisable":t[12]||(t[12]=n=>s.tradeVisable=n),status:s.tradeStatus,tradeHash:s.tradeHash},null,8,["tradeVisable","status","tradeHash"])],64)}const Se=P(de,[["render",$e],["__scopeId","data-v-1b68c776"]]);export{Se as default};
