import{D as N}from"./dialogBase.1146a7ec.js";import{_ as P,c as F,o as u,a as $,w as i,b as r,d as k,t as d,e as y,f as w,r as c,p as B,g as x,k as p,ag as H,T as V,s as S,m as n,F as U}from"./index.334a89c2.js";const z={name:"ChainTrade",components:{DialogBase:N},props:{tradeVisable:{type:Boolean,default:!1},status:{type:Number,default:0},tradeHash:{type:String,default:""}},emits:["update:tradeVisable"],methods:{copy:F}},I=t=>(B("data-v-a156f7ea"),t=t(),x(),t),R={class:"status-content"},E={class:"status-text"},q={key:0},M={key:1},j={key:2},J={key:3},W={key:4},K={class:"status-icon"},O={class:"trade-hash"},G={key:0},Q=I(()=>r("use",{"xlink:href":"#icon-copy"},null,-1)),X=[Q],Y={key:1},Z=I(()=>r("span",null,"N/A",-1)),tt=[Z];function et(t,e,o,_,s,h){const g=c("van-loading"),m=c("van-icon"),f=c("DialogBase");return u(),$(f,{class:"trade-box",visible:o.tradeVisable,"onUpdate:visible":e[2]||(e[2]=l=>o.tradeVisable=l),autoClose:!1,closeable:!1,clickOverlayIsClose:!1,title:t.$t("transactionDetails"),showConfirmButton:!1,showCancelButton:!1},{default:i(()=>[r("div",R,[r("div",E,[o.status==0?(u(),k("span",q,d(t.$t("sendingTransactionToBlockchain")),1)):o.status==1?(u(),k("span",M,d(t.$t("waitingForServiceSyncronizing")),1)):o.status==2?(u(),k("span",j,d(t.$t("transactionSuccess")),1)):o.status==-1?(u(),k("span",J,d(t.$t("sendTransactionToBlockchainFailed")),1)):o.status==-2?(u(),k("span",W,d(t.$t("servicesyncronizingTimeout")),1)):y("",!0)]),r("div",K,[o.status==0||o.status==1?(u(),$(g,{key:0,type:"spinner",size:"48px"})):y("",!0),o.status==2?(u(),$(m,{key:1,color:"#07c160",size:"40px",name:"checked"})):y("",!0),o.status==-1||o.status==-2?(u(),$(m,{key:2,color:"#FA5151",size:"40px",name:"clear"})):y("",!0)]),r("div",O,[w(d(t.$t("txHash")+":")+" ",1),o.status==1||o.status==2||o.status==-2?(u(),k("text",G,[r("span",{onClick:e[0]||(e[0]=(...l)=>t.jumpToTxDetail&&t.jumpToTxDetail(...l))},d(t.$f.formatAddress(o.tradeHash,6)),1),(u(),k("svg",{class:"icon-svg icon-renzheng","aria-hidden":"true",onClick:e[1]||(e[1]=l=>h.copy(o.tradeHash))},X))])):o.status==0||o.status==-1?(u(),k("text",Y,tt)):y("",!0)])])]),_:1},8,["visible","title"])}const st=P(z,[["render",et],["__scopeId","data-v-a156f7ea"]]),at="/assets/svg/redPacket/luck.svg",nt="/assets/svg/redPacket/redPacket.svg";const ot={name:"CreateRedPacket",components:{ChainTrade:st},computed:{totalAmount(){if(this.type=="0")return this.amount?parseInt(this.amount):0;if(this.type=="1")return this.amount&&this.count?parseInt(this.amount)*parseInt(this.count):0}},data(){return{tradeVisable:!1,tradeStatus:0,tradeHash:"",type:"0",result:"",showTokenPicker:!1,count:"",tokenType:["JF"],amount:"",symbol:"JF",showDeadlinePicker:!1,deadlineList:[{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},{text:this.$t("deadlineList.600"),value:600,showText:this.$t("deadlineList.600Show")},{text:this.$t("deadlineList.1800"),value:1800,showText:this.$t("deadlineList.1800Show")},{text:this.$t("deadlineList.3600"),value:3600,showText:this.$t("deadlineList.3600Show")},{text:this.$t("deadlineList.43200"),value:43200,showText:this.$t("deadlineList.43200Show")},{text:this.$t("deadlineList.86400"),value:86400,showText:this.$t("deadlineList.86400Show")}],deadline:{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},remark:"",balance:0,tokenAddress:"0xaf22F677373352761B7F8FAfF4c9aD7bd8B6Be42",contractAddress:"0xad3f6E6d8B3D08Ed7d46988fDb4a324e6F6006C6"}},methods:{async getTokenList(){await p.user.getUserTokenList(this.$store.state.user.userAddress,H[this.$store.state.chainId]),await p.redPacket.tokenlistcheck([])},onTokenConfirm(t){this.balance=0,this.symbol=t,this.showTokenPicker=!1,this.getBalance()},onDeadlineConfirm(t){this.deadline=t,this.showDeadlinePicker=!1},async getBalance(){try{this.balance=await p.contract.getBalance(this.tokenAddress,this.$store.state.user.userAddress)}catch{this.$store.state.wallet=="WalletConnect"&&await this.$store.state.provider.disconnect(),this.$store.commit("logout")}},async sendRedPacket(){const t=Number(this.amount),e=Number(this.count);if(t<=0){V("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E\u7B49\u4E8E0");return}if(e<1){V("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E1");return}if(e>this.$store.state.group.totalMembers){V("\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC7\u672C\u7FA4\u4EBA\u6570");return}if(Number(this.totalAmount)>this.balance){V("\u4F59\u989D\u4E0D\u8DB3");return}this.tradeStatus=0,this.tradeVisable=!0;try{let _=this.deadline.value;if(console.log("\u53D1\u9001\u7EA2\u5305"),!await this.auth())throw"not auth";console.log("auth");const h={_owner:this.$store.state.user.userAddress,token:this.tokenAddress,amount:t,unlockDate:_,quantity:e,kind:this.type};let g=await p.contract.lock(this.contractAddress,h);console.dir(g);let m=await g.wait();this.tradeStatus=1,this.tradeHash=m.transactionHash,this.tradeVisable=!0,console.dir(m);let f=m==null?void 0:m.events,l={};for(let b=f.length-1;b>=0;b--){let D=f[b].topics.some(a=>a==="0x694af1cc8727cdd0afbdd53d9b87b69248bd490224e9dd090e788546506e076f");if(f[b].address==this.contractAddress&&D){l=f[b];break}}let A=l.data.slice(-128,-64);const T=await p.contract.getDecimal(this.tokenAddress),v=await p.contract.getAmount(this.tokenAddress,"0x"+A),C={groupId:this.$route.params.groupId,contractAddress:this.tokenAddress,contractChain:"eth",contractDecimal:T,count:e,endTime:_,redPacketId:l.topics[1],remark:this.remark,singleAmount:t,symbol:this.symbol,totalAmount:Number(this.totalAmount),tx:m.transactionHash,type:Number(this.type)};await p.redPacket.send(C),this.tradeStatus=2,await S(1e3),this.$router.push({name:"Chat",params:{groupId:this.$route.params.groupId}})}catch(_){console.log(_),this.tradeStatus=-1,await S(1e3),this.tradeVisable=!1}},async auth(){let t=await this.allowance();if(!t){const e=await p.contract.approve(this.contractAddress,this.tokenAddress);console.log("approve",e),e&&(t=await this.allowance())}return t},async allowance(){const t=await p.contract.allowanceSend({spender:this.contractAddress,tokenAddress:this.tokenAddress,account:this.$store.state.user.userAddress});return console.log("allowanceSend",t),t}},mounted(){this.getBalance()}},L=t=>(B("data-v-97dc4702"),t=t(),x(),t),it={class:"myChats-container"},lt={class:"body"},rt=L(()=>r("img",{class:"left-icon",src:at,alt:"",srcset:""},null,-1)),dt={class:"desc-text margin-bottom"},ut=L(()=>r("img",{class:"left-icon",src:nt,alt:"",srcset:""},null,-1)),ct={class:"desc-text margin-bottom"},mt={class:"total"},ht={class:"amount"},pt={style:{margin:"16px"}},kt={class:"bottom"};function ft(t,e,o,_,s,h){const g=c("van-nav-bar"),m=c("van-radio"),f=c("van-radio-group"),l=c("van-field"),A=c("van-picker"),T=c("van-popup"),v=c("van-cell-group"),C=c("van-button"),b=c("van-form"),D=c("ChainTrade");return u(),k(U,null,[r("section",it,[n(g,{fixed:"","left-arrow":"","safe-area-inset-top":"","z-index":"2",title:t.$t("createRedPacket"),onClickLeft:e[0]||(e[0]=a=>t.$router.push({name:"Chat",params:{groupId:t.$route.params.groupId}}))},null,8,["title"]),r("div",lt,[n(b,{onSubmit:h.sendRedPacket},{default:i(()=>[n(l,{name:"type",class:"red-packet-type"},{input:i(()=>[n(f,{modelValue:s.type,"onUpdate:modelValue":e[1]||(e[1]=a=>s.type=a),direction:"horizontal"},{default:i(()=>[n(m,{"checked-color":"#ED4A4A",name:"0"},{default:i(()=>[w(d(t.$t("randomAmount")),1)]),_:1}),n(m,{"checked-color":"#ED4A4A",name:"1"},{default:i(()=>[w(d(t.$t("identicalAmount")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1}),n(v,{inset:"",class:"margin-bottom"},{default:i(()=>[n(l,{modelValue:s.symbol,"onUpdate:modelValue":e[2]||(e[2]=a=>s.symbol=a),"is-link":"",readonly:"",name:"picker",label:t.$t("token"),onClick:e[3]||(e[3]=a=>s.showTokenPicker=!0),"input-align":"right"},null,8,["modelValue","label"]),n(T,{show:s.showTokenPicker,"onUpdate:show":e[5]||(e[5]=a=>s.showTokenPicker=a),position:"bottom"},{default:i(()=>[n(A,{columns:s.tokenType,onCancel:e[4]||(e[4]=a=>s.showTokenPicker=!1),onConfirm:h.onTokenConfirm,title:t.$t("settingToken"),"confirm-button-text":t.$t("confirm"),"cancel-button-text":t.$t("cancel")},null,8,["columns","onConfirm","title","confirm-button-text","cancel-button-text"])]),_:1},8,["show"])]),_:1}),n(v,{inset:""},{default:i(()=>[n(l,{label:t.$t("amount"),class:"ipt-num"},{"left-icon":i(()=>[rt]),input:i(()=>[n(l,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":e[6]||(e[6]=a=>s.amount=a),type:"number","error-message-align":"right",rules:[{required:!0,message:t.$t("enterAmount")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1}),r("div",dt,d(`${t.$t("availableBalance")} ${s.balance?s.balance:"--"} ${s.symbol} `),1),n(v,{inset:""},{default:i(()=>[n(l,{label:t.$t("quantity"),class:"ipt-num"},{"left-icon":i(()=>[ut]),input:i(()=>[n(l,{"input-align":"right",modelValue:s.count,"onUpdate:modelValue":e[7]||(e[7]=a=>s.count=a),type:"digit","error-message-align":"right",rules:[{required:!0,message:t.$t("enterNumber")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1}),r("div",ct,d(`${t.$t("totalMembers1")} ${t.$store.state.group.totalMembers} ${t.$t("totalMembers2")}`),1),n(v,{inset:"",class:"margin-bottom"},{default:i(()=>[n(l,{modelValue:s.deadline.text,"onUpdate:modelValue":e[8]||(e[8]=a=>s.deadline.text=a),"is-link":"",readonly:"",name:"picker",label:t.$t("deadline"),onClick:e[9]||(e[9]=a=>s.showDeadlinePicker=!0),"input-align":"right"},null,8,["modelValue","label"]),n(T,{show:s.showDeadlinePicker,"onUpdate:show":e[11]||(e[11]=a=>s.showDeadlinePicker=a),position:"bottom"},{default:i(()=>[n(A,{columns:s.deadlineList,onCancel:e[10]||(e[10]=a=>s.showDeadlinePicker=!1),onConfirm:h.onDeadlineConfirm,title:t.$t("settingDeadline"),"confirm-button-text":t.$t("confirm"),"cancel-button-text":t.$t("cancel")},null,8,["columns","onConfirm","title","confirm-button-text","cancel-button-text"])]),_:1},8,["show"])]),_:1}),n(v,{inset:""},{default:i(()=>[n(l,{modelValue:s.remark,"onUpdate:modelValue":e[12]||(e[12]=a=>s.remark=a),rows:"2",autosize:"",placeholder:t.$t("bestWishes"),type:"textarea",maxlength:"20","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1}),r("div",mt,[w(d(t.$t("totalAmount")),1),r("span",ht,d(h.totalAmount?h.totalAmount:"--"),1),w(d(s.symbol),1)]),r("div",pt,[n(C,{round:"",block:"",type:"default","native-type":"submit"},{default:i(()=>[w(d(t.$t("send")),1)]),_:1})])]),_:1},8,["onSubmit"]),r("div",kt,d(`${t.$t("createRedPacketTips1")} ${s.deadline.showText} ${t.$t("createRedPacketTips2")}`),1)])]),n(D,{tradeVisable:s.tradeVisable,"onUpdate:tradeVisable":e[13]||(e[13]=a=>s.tradeVisable=a),status:s.tradeStatus,tradeHash:s.tradeHash},null,8,["tradeVisable","status","tradeHash"])],64)}const gt=P(ot,[["render",ft],["__scopeId","data-v-97dc4702"]]);export{gt as default};
