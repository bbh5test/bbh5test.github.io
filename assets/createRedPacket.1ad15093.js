import{D as E}from"./dialogBase.5e1675a0.js";import{_ as H,c as F,o as c,a as b,w as i,b as r,d as g,t as u,e as $,f as w,r as h,p as U,g as x,ag as D,k as p,s as I,T as _,ah as W,i as q,m as o,F as P,x as M}from"./index.04197bd2.js";const j={name:"ChainTrade",components:{DialogBase:E},props:{tradeVisable:{type:Boolean,default:!1},status:{type:Number,default:0},tradeHash:{type:String,default:""}},emits:["update:tradeVisable","close"],methods:{copy:F,close(){this.$emit("close")}}},z=e=>(U("data-v-c3eca6bd"),e=e(),x(),e),G={class:"status-content"},J={class:"status-text"},K={key:0},O={key:1},Q={key:2},X={key:3},Y={key:4},Z={class:"status-icon"},ee={class:"trade-hash"},te={key:0},se=z(()=>r("use",{"xlink:href":"#icon-copy"},null,-1)),ae=[se],ne={key:1},oe=z(()=>r("span",null,"N/A",-1)),ie=[oe];function le(e,t,a,T,s,m){const k=h("van-loading"),l=h("van-icon"),f=h("DialogBase");return c(),b(f,{class:"trade-box",visible:a.tradeVisable,"onUpdate:visible":t[2]||(t[2]=d=>a.tradeVisable=d),autoClose:!1,closeable:a.status==2,clickOverlayIsClose:!1,title:e.$t("transactionDetails"),showConfirmButton:!1,showCancelButton:!1,onClose:m.close},{default:i(()=>[r("div",G,[r("div",J,[a.status==0?(c(),g("span",K,u(e.$t("sendingTransactionToBlockchain")),1)):a.status==1?(c(),g("span",O,u(e.$t("waitingForServiceSyncronizing")),1)):a.status==2?(c(),g("span",Q,u(e.$t("transactionSuccess")),1)):a.status==-1?(c(),g("span",X,u(e.$t("sendTransactionToBlockchainFailed")),1)):a.status==-2?(c(),g("span",Y,u(e.$t("servicesyncronizingTimeout")),1)):$("",!0)]),r("div",Z,[a.status==0||a.status==1?(c(),b(k,{key:0,type:"spinner",size:"48px"})):$("",!0),a.status==2?(c(),b(l,{key:1,color:"#07c160",size:"40px",name:"checked"})):$("",!0),a.status==-1||a.status==-2?(c(),b(l,{key:2,color:"#FA5151",size:"40px",name:"clear"})):$("",!0)]),r("div",ee,[w(u(e.$t("txHash")+":")+" ",1),a.status==1||a.status==2||a.status==-2?(c(),g("text",te,[r("span",{onClick:t[0]||(t[0]=(...d)=>e.jumpToTxDetail&&e.jumpToTxDetail(...d))},u(e.$f.formatAddress(a.tradeHash,6)),1),(c(),g("svg",{class:"icon-svg icon-renzheng","aria-hidden":"true",onClick:t[1]||(t[1]=d=>m.copy(a.tradeHash))},ae))])):a.status==0||a.status==-1?(c(),g("text",ne,ie)):$("",!0)])])]),_:1},8,["visible","closeable","title","onClose"])}const re=H(j,[["render",le],["__scopeId","data-v-c3eca6bd"]]),de="/assets/svg/redPacket/luck.svg",ce="/assets/svg/redPacket/redPacket.svg";const ue={name:"CreateRedPacket",components:{ChainTrade:re},computed:{totalAmount(){if(this.type=="0")return this.amount?this.amount:0;if(this.type=="1")if(this.amount&&this.count){const e=Number(this.amount),t=Number(this.count);return D(e).multipliedBy(t).toNumber()}else return 0}},data(){return{sendLoading:!1,approveTradeVisable:!1,approveTradeStatus:0,approveTradeHash:"",sendTradeVisable:!1,sendTradeStatus:0,sendTradeHash:"",type:"0",result:"",showTokenSelect:!1,count:"",chain:"",amount:"",symbol:"",showDeadlinePicker:!1,deadlineList:[{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},{text:this.$t("deadlineList.600"),value:600,showText:this.$t("deadlineList.600Show")},{text:this.$t("deadlineList.1800"),value:1800,showText:this.$t("deadlineList.1800Show")},{text:this.$t("deadlineList.3600"),value:3600,showText:this.$t("deadlineList.3600Show")},{text:this.$t("deadlineList.43200"),value:43200,showText:this.$t("deadlineList.43200Show")},{text:this.$t("deadlineList.86400"),value:86400,showText:this.$t("deadlineList.86400Show")}],deadline:{text:this.$t("deadlineList.300"),value:300,showText:this.$t("deadlineList.300Show")},remark:"",tokenAddress:"",contractAddress:"0xad3f6E6d8B3D08Ed7d46988fDb4a324e6F6006C6",tokenList:[],balance:-1,needApprove:!1}},methods:{sendTradeClose(){this.$router.push({name:"Chat",params:{groupId:this.$route.params.groupId}})},async approve(){this.approveTradeStatus=0,this.approveTradeVisable=!0,this.approveTradeHash="";try{const e=await p.contract.approve(this.contractAddress,this.tokenAddress);console.log("approve",e),e?(this.approveTradeHash=e.hash,this.approveTradeStatus=1,await e.wait(),this.approveTradeStatus=2,this.needApprove=!1):(this.approveTradeStatus=-1,await I(1e3),this.approveTradeVisable=!1)}catch{this.approveTradeStatus=-1,await I(1e3),this.approveTradeVisable=!1}},async selectToken(e){this.showTokenSelect=!1,this.tokenAddress=e.address,this.symbol=e.symbol,this.chain=e.chain,this.balance=-1;let t=_.loading();await this.getBalance(),console.log("allowance");const a=await this.allowance();this.needApprove=!a,t.clear()},async getTokenList(){this.tokenList=[];const e=this.$store.state.user.userAddress,t=this.$store.state.chainId;if(t==4){this.tokenList=[{address:"0xaf22f677373352761b7f8faff4c9ad7bd8b6be42",tokenId:"0xaf22f677373352761b7f8faff4c9ad7bd8b6be42-eth",chain:"eth",symbol:"JF",decimals:18,image:"/assets/images/groupAvatar.png",amount:0}];return}const a=_.loading();let s=(await p.user.getUserTokenList(e,W[t])).data.filter(l=>new RegExp("^0x.*$","gi").test(l.id)).map(l=>({address:l.id.toLowerCase(),tokenId:`${l.id}-${l.chain}`.toLowerCase(),chain:l.chain.toLowerCase(),symbol:l.symbol,decimals:l.decimals,image:l.logo_url,amount:l.amount})),m=s.map(l=>l.tokenId),k=await p.redPacket.tokenlistcheck(m);this.tokenList=s.filter(l=>k.data[l.tokenId].riskScore<60),a.clear()},onDeadlineConfirm(e){this.deadline=e,this.showDeadlinePicker=!1},async getBalance(){try{this.balance=await p.contract.getBalance(this.tokenAddress,this.$store.state.user.userAddress)}catch(e){console.log(e),this.$store.state.wallet=="WalletConnect"&&await this.$store.state.provider.disconnect(),this.$store.commit("logout"),this.$store.dispatch("checkLogin")}},async sendRedPacket(){this.sendLoading=!0;const e=Number(this.amount),t=Number(this.count);let a=0;if(this.type=="0"?a=D(e).toNumber():a=D(e).multipliedBy(t).toNumber(),!this.tokenAddress){_(this.$t("selectTokenFirst")),this.sendLoading=!1;return}if(e<=0){_(this.$t("amountWarn")),this.sendLoading=!1;return}if(t<1){_(this.$t("countWarn")),this.sendLoading=!1;return}if(t>this.$store.state.group.totalMembers){_(this.$t("countGroupWarn")),this.sendLoading=!1;return}if(a>this.balance){_(this.$t("blanceSlow")),this.sendLoading=!1;return}let T=this.deadline.value,s=await p.contract.checkNetAndToken();if(console.log(s),s=="netErr"){await q(),this.sendLoading=!1;return}else if(s=="tokenErr"){this.$toast({duration:3e3,message:this.$t("switchAccountWarn")}),this.sendLoading=!1;return}else if(s==!1){this.$store.state.wallet=="WalletConnect"&&await this.$store.state.provider.disconnect(),this.$store.commit("logout"),this.$store.commit("setUserInfo",{}),this.$store.commit("setTradeVisable",!1),this.$store.dispatch("checkLogin"),this.sendLoading=!1;return}if(!await this.allowance()){this.needApprove=!0,_("need approve"),this.sendLoading=!1;return}console.log(a),this.sendTradeStatus=0,this.sendTradeVisable=!0;try{console.log("\u53D1\u9001\u7EA2\u5305");const k={_owner:this.$store.state.user.userAddress,token:this.tokenAddress,amount:a,unlockDate:T,quantity:t,kind:this.type};let l=await p.contract.lock(this.contractAddress,k);console.dir(l);let f=await l.wait();this.sendTradeStatus=1,this.sendTradeHash=f.transactionHash,this.sendTradeVisable=!0,console.dir(f);let d=f==null?void 0:f.events,A={};for(let y=d.length-1;y>=0;y--){let V=d[y].topics.some(S=>S==="0x694af1cc8727cdd0afbdd53d9b87b69248bd490224e9dd090e788546506e076f");if(d[y].address==this.contractAddress&&V){A=d[y];break}}let L=A.data.slice(-128,-64);const v=await p.contract.getDecimal(this.tokenAddress),B=await p.contract.getAmount(this.tokenAddress,"0x"+L),C={groupId:this.$route.params.groupId,contractAddress:this.tokenAddress,contractChain:this.chain,contractDecimal:v,count:t,endTime:T,redPacketId:A.topics[1],remark:this.remark,singleAmount:e,symbol:this.symbol,totalAmount:a,tx:f.transactionHash,type:Number(this.type)};await p.redPacket.send(C),this.sendTradeStatus=2,this.sendLoading=!1}catch(k){console.log(k),this.sendTradeStatus=-1,await I(1e3),this.sendTradeVisable=!1,this.sendLoading=!1}},async auth(){let e=await this.allowance();if(!e){const t=await p.contract.approve(this.contractAddress,this.tokenAddress);console.log("approve",t),t&&(e=await this.allowance())}return e},async allowance(){return await p.contract.allowanceSend({spender:this.contractAddress,tokenAddress:this.tokenAddress,account:this.$store.state.user.userAddress})}},mounted(){this.getTokenList()}},R=e=>(U("data-v-70d33f20"),e=e(),x(),e),he={class:"myChats-container"},me={class:"body"},pe={class:"token"},fe={class:"token-symbol"},ge=w("\xA0\xA0 "),ke=R(()=>r("img",{class:"left-icon",src:de,alt:"",srcset:""},null,-1)),ve={class:"desc-text margin-bottom"},be=R(()=>r("img",{class:"left-icon",src:ce,alt:"",srcset:""},null,-1)),_e={class:"desc-text margin-bottom"},we={class:"total"},ye={class:"amount"},Te={style:{margin:"16px"}},Ae=w("Approve"),$e={class:"bottom"};function Ve(e,t,a,T,s,m){const k=h("van-nav-bar"),l=h("van-radio"),f=h("van-radio-group"),d=h("van-field"),A=h("van-image"),L=h("van-cell"),v=h("van-cell-group"),B=h("van-action-sheet"),C=h("van-picker"),y=h("van-popup"),V=h("van-button"),S=h("van-form"),N=h("ChainTrade");return c(),g(P,null,[r("section",he,[o(k,{fixed:"","left-arrow":"","safe-area-inset-top":"","z-index":"2",title:e.$t("createRedPacket"),onClickLeft:t[0]||(t[0]=n=>e.$router.push({name:"Chat",params:{groupId:e.$route.params.groupId}}))},null,8,["title"]),r("div",me,[o(S,null,{default:i(()=>[o(d,{name:"type",class:"red-packet-type"},{input:i(()=>[o(f,{modelValue:s.type,"onUpdate:modelValue":t[1]||(t[1]=n=>s.type=n),direction:"horizontal"},{default:i(()=>[o(l,{"checked-color":"#ED4A4A",name:"0"},{default:i(()=>[w(u(e.$t("randomAmount")),1)]),_:1}),o(l,{"checked-color":"#ED4A4A",name:"1"},{default:i(()=>[w(u(e.$t("identicalAmount")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(v,{inset:"",class:"margin-bottom"},{default:i(()=>[o(d,{modelValue:s.symbol,"onUpdate:modelValue":t[2]||(t[2]=n=>s.symbol=n),"is-link":"",readonly:"",name:"picker",label:e.$t("token"),onClick:t[3]||(t[3]=n=>s.showTokenSelect=!0),"input-align":"right"},null,8,["modelValue","label"]),o(B,{show:s.showTokenSelect,"onUpdate:show":t[4]||(t[4]=n=>s.showTokenSelect=n),title:e.$t("settingToken")},{default:i(()=>[r("div",pe,[o(v,{inset:""},{default:i(()=>[(c(!0),g(P,null,M(s.tokenList,n=>(c(),b(L,{key:n.address,clickable:"",onClick:Le=>m.selectToken(n)},{title:i(()=>[r("div",fe,[o(A,{class:"symbol-icon",round:"",width:"0.4rem",height:"0.4rem","icon-size":"0.4rem","lazy-load":"","show-loading":"",src:n.image,"error-icon":"/assets/images/groupAvatar.png"},null,8,["src"]),r("span",null,u(n.symbol),1)])]),value:i(()=>[r("div",null,[r("span",null,u(e.$t("balance"))+": "+u(e.$f.formatNumUnit(n.amount)),1),ge])]),_:2},1032,["onClick"]))),128))]),_:1})])]),_:1},8,["show","title"])]),_:1}),s.type=="0"?(c(),b(v,{key:0,inset:""},{default:i(()=>[o(d,{label:e.$t("totalAmount2"),class:"ipt-num"},{"left-icon":i(()=>[ke]),input:i(()=>[o(d,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":t[5]||(t[5]=n=>s.amount=n),type:"number",maxlength:"10","error-message-align":"right",rules:[{required:!0,message:e.$t("enterAmount")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1})):(c(),b(v,{key:1,inset:""},{default:i(()=>[o(d,{label:e.$t("singleAmount"),class:"ipt-num"},{input:i(()=>[o(d,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":t[6]||(t[6]=n=>s.amount=n),type:"number",maxlength:"10","error-message-align":"right",rules:[{required:!0,message:e.$t("enterAmount")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1})),r("div",ve,u(`${e.$t("availableBalance")} ${s.balance>0?s.balance:"--"} ${s.symbol} `),1),o(v,{inset:""},{default:i(()=>[o(d,{label:e.$t("quantity"),class:"ipt-num"},{"left-icon":i(()=>[be]),input:i(()=>[o(d,{"input-align":"right",modelValue:s.count,"onUpdate:modelValue":t[7]||(t[7]=n=>s.count=n),type:"digit",maxlength:"10","error-message-align":"right",rules:[{required:!0,message:e.$t("enterNumber")}]},null,8,["modelValue","rules"])]),_:1},8,["label"])]),_:1}),r("div",_e,u(`${e.$t("totalMembers1")} ${e.$store.state.group.totalMembers} ${e.$t("totalMembers2")}`),1),o(v,{inset:"",class:"margin-bottom"},{default:i(()=>[o(d,{modelValue:s.deadline.text,"onUpdate:modelValue":t[8]||(t[8]=n=>s.deadline.text=n),"is-link":"",readonly:"",name:"picker",label:e.$t("deadline"),onClick:t[9]||(t[9]=n=>s.showDeadlinePicker=!0),"input-align":"right"},null,8,["modelValue","label"]),o(y,{show:s.showDeadlinePicker,"onUpdate:show":t[11]||(t[11]=n=>s.showDeadlinePicker=n),position:"bottom"},{default:i(()=>[o(C,{columns:s.deadlineList,onCancel:t[10]||(t[10]=n=>s.showDeadlinePicker=!1),onConfirm:m.onDeadlineConfirm,title:e.$t("settingDeadline"),"confirm-button-text":e.$t("confirm"),"cancel-button-text":e.$t("cancel")},null,8,["columns","onConfirm","title","confirm-button-text","cancel-button-text"])]),_:1},8,["show"])]),_:1}),o(v,{inset:""},{default:i(()=>[o(d,{modelValue:s.remark,"onUpdate:modelValue":t[12]||(t[12]=n=>s.remark=n),rows:"2",autosize:"",placeholder:e.$t("bestWishes"),type:"textarea",maxlength:"20","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1}),r("div",we,[w(u(e.$t("totalAmount")),1),r("span",ye,u(m.totalAmount?m.totalAmount:"--"),1),w(u(s.symbol),1)]),r("div",Te,[s.needApprove?(c(),b(V,{key:0,round:"",block:"",type:"default","native-type":"submit",onClick:m.approve},{default:i(()=>[Ae]),_:1},8,["onClick"])):(c(),b(V,{key:1,round:"",block:"",type:"default","native-type":"submit",loading:s.sendLoading,onClick:m.sendRedPacket},{default:i(()=>[w(u(e.$t("send")),1)]),_:1},8,["loading","onClick"]))])]),_:1}),r("div",$e,u(`${e.$t("createRedPacketTips1")} ${s.deadline.showText} ${e.$t("createRedPacketTips2")}`),1)])]),o(N,{tradeVisable:s.approveTradeVisable,"onUpdate:tradeVisable":t[13]||(t[13]=n=>s.approveTradeVisable=n),status:s.approveTradeStatus,tradeHash:s.approveTradeHash},null,8,["tradeVisable","status","tradeHash"]),o(N,{tradeVisable:s.sendTradeVisable,"onUpdate:tradeVisable":t[14]||(t[14]=n=>s.sendTradeVisable=n),status:s.sendTradeStatus,tradeHash:s.sendTradeHash,onClose:m.sendTradeClose},null,8,["tradeVisable","status","tradeHash","onClose"])],64)}const De=H(ue,[["render",Ve],["__scopeId","data-v-70d33f20"]]);export{De as default};
