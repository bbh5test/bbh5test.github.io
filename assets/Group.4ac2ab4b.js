import{_ as B,D as I,c as L,a as V,b as T,B as N,d as b,s as D,e as j,r as l,o as s,f as c,w as h,g as o,t as v,h as r,i as d,j as m,k,p as F,l as W,m as P,K as U,F as z}from"./index.cf87c7de.js";const H={name:"BlablaPay",inject:["reload"],components:{DialogBase:I},data(){return{contractAddress:"0x1BEcc0D044267540e81C1d203Eb7875ED9ff120F",jfTokenAddress:"0xaf22F677373352761B7F8FAfF4c9aD7bd8B6Be42",tradeHash:"N/A",tradeStatus:void 0,payWay:0,unUsedNum:0,tokenId:"0",isShowApprove:!1,isShowButton:!1,isConfirmLoading:!1,isApproveLoading:!1}},watch:{"$store.state.group.tradeVisable"(t){t&&this.init()}},computed:{tradeVisable:{get(){return this.$store.state.group.tradeVisable},set(t){this.$store.commit("setTradeVisable",t),this.tradeStatus==2&&this.reload()}},paymentType(){return this.$store.state.group.paymentType}},mounted(){},methods:{copy:L,async init(){if(this.tradeHash="N/A",this.tradeStatus=void 0,this.payWay=0,this.unUsedNum=0,this.tokenId="0",this.isShowApprove=!1,this.isShowButton=!1,this.isConfirmLoading=!1,this.isApproveLoading=!1,!await this.$store.dispatch("getPaymentListAction"))this.payWay=2;else{let a=this.$store.state.user.paymentList;if(a.length==0)this.payWay=2;else{let n=0;for(let u of a)this.paymentType==0?u.status==0&&u.paymentType==0&&(n=n+1):this.paymentType==1&&u.status==0&&u.paymentType==1&&(n=n+1);n>0?(this.payWay=1,this.unUsedNum=n):this.payWay=2}}this.isShowButton=!0},async changeTokenId(){if(this.isShowButton=!1,this.tokenId==1&&!await V({spender:this.contractAddress,tokenAddress:this.jfTokenAddress,account:this.$store.state.user.userAddress})){this.isShowApprove=!0,this.$toast("\u8BF7\u5148\u6388\u6743");return}this.isShowApprove=!1,this.isShowButton=!0},async payConfirm(){if(this.isConfirmLoading=!0,this.payWay==1){let t=await this.trade();if(t=="fail")this.$toast.fail("\u652F\u4ED8\u5931\u8D25\uFF0C\u8BF7\u91CD\u65B0\u652F\u4ED8");else if(t=="success"){let a;this.paymentType==0?a="\u8D2D\u4E70\u7BA1\u7406\u5458\u6210\u529F":this.paymentType==1&&(a="\u8FDD\u89C4\u5904\u7F5A\u652F\u4ED8\u6210\u529F"),this.$toast.success(a),this.$store.commit("setTradeVisable",!1)}}else{if(console.log(await T()),!await T()){console.log("\u6821\u9A8C\u7F51\u7EDC\u548C\u8D26\u6237\u51FA\u9519"),this.$store.commit("logout"),this.$store.commit("setUserInfo",{}),this.$store.commit("setTradeVisable",!1),this.$store.dispatch("checkLogin"),this.isConfirmLoading=!1;return}this.tradeStatus=0,this.isShowButton=!1;try{let t=await N(this.contractAddress,this.paymentType,parseInt(this.tokenId));t&&(console.log(t),this.tradeHash=t.hash,this.tradeStatus=1,await this.timeCheckTrade())}catch{this.tradeStatus=-1}}this.isConfirmLoading=!1},async trade(){try{if(this.paymentType==0){if((await b.groupMember.buyManager(this.$store.state.group.groupId)).status==1)return await this.$store.dispatch("getGroupDetail",this.$route.params.groupId),this.$store.commit("setCurrentUserRole",1),"success"}else if(this.paymentType==1&&(await b.groupViolation.dealWithViolation(this.$store.state.group.groupId)).status==1)return this.$store.commit("setGroupStatus",0),this.$router.push({name:"GroupDetail",params:{groupId:this.$route.params.groupId}}),"success"}catch(t){console.log(t)}return"fail"},async timeCheckTrade(){console.log("timeCheckTrade");let t=!1,a=setTimeout(async function(){t=!0},6e4);for(;;){try{if(await this.trade()=="success"){this.tradeStatus=2,clearTimeout(a);break}}catch(n){console.log(n)}if(t){this.tradeStatus=-2;break}await D(3e3)}},async approve(){this.isApproveLoading=!0;try{let t=await j(this.contractAddress,this.jfTokenAddress);t&&(this.isShowApprove=!1,this.isShowButton=!0),console.log(t)}catch(t){console.log(t)}finally{this.isApproveLoading=!1}},jumpToTxDetail(){window.open("https://rinkeby.etherscan.io/tx/"+this.tradeHash,"_blank")},jumpToPaymentList(){this.$store.commit("setTradeVisable",!1),this.$router.push({name:"PaymentList"})}}},A=t=>(F("data-v-f109d4d2"),t=t(),W(),t),G={key:0,class:"pay-way"},E={key:1,class:"has-unused"},O={key:0},R={key:1},K={key:2,class:"no-unused"},M={key:0},J={key:1},q=k("\u652F\u4ED8 1 BNB"),Q=k("\u652F\u4ED8 200 JF"),X=k("approve"),Y={key:1,class:"status-content"},Z={class:"status-text"},$={key:0},ee={key:1},te={key:2},se={key:3},ae={class:"status-icon"},oe={class:"trade-hash"},ie=k(" \u4EA4\u6613Hash\uFF1A "),ne={key:0},re=A(()=>d("use",{"xlink:href":"#icon-copy"},null,-1)),le=[re],ce={key:1},de=A(()=>d("span",null,"N/A",-1)),ue=[de];function pe(t,a,n,u,e,i){const y=l("van-loading"),f=l("van-radio"),_=l("van-radio-group"),C=l("van-button"),S=l("van-icon"),x=l("DialogBase");return s(),c(x,{class:"trade-box",autoClose:!1,clickOverlayIsClose:!1,visible:i.tradeVisable,"onUpdate:visible":a[4]||(a[4]=g=>i.tradeVisable=g),title:typeof e.tradeStatus!="number"?"\u63D0\u793A":"\u4EA4\u6613\u8BE6\u60C5",showConfirmButton:e.isShowButton,showCancelButton:e.isShowButton,onOnConfirm:i.payConfirm,confirmLoading:e.isConfirmLoading},{default:h(()=>{var g,w;return[typeof e.tradeStatus!="number"?(s(),o("div",G,[e.payWay==0?(s(),c(y,{key:0,type:"spinner",size:"48px"})):e.payWay==1?(s(),o("div",E,[i.paymentType==1?(s(),o("span",O," \u4F60\u6709"+v(e.unUsedNum)+"\u6B21\u672A\u4F7F\u7528\u7684\u652F\u4ED8\u8BB0\u5F55\u53EF\u7528\u4E8E\u8FDD\u89C4\u5904\u7F5A\uFF0C\u4E00\u65E6\u4F60\u5904\u7406\u4E86\u8FD9\u6B21\u8FDD\u89C4\uFF0C\u5C31\u4F1A\u4F7F\u7528\u4E00\u6761\u652F\u4ED8\u8BB0\u5F55\u3002 ",1)):i.paymentType==0?(s(),o("span",R," \u4F60\u6709"+v(e.unUsedNum)+"\u6B21\u672A\u4F7F\u7528\u7684\u652F\u4ED8\u8BB0\u5F55\u53EF\u7528\u4E8E\u7BA1\u7406\u5458\u8D2D\u4E70\uFF0C\u4E00\u65E6\u4F60\u8D2D\u4E70\u4E86\u7BA1\u7406\u5458\uFF0C\u5C31\u4F1A\u4F7F\u7528\u4E00\u6761\u652F\u4ED8\u8BB0\u5F55\u3002 ",1)):r("",!0)])):e.payWay==2?(s(),o("div",K,[d("label",null,[i.paymentType==1?(s(),o("span",M,"\u9009\u62E9\u4E00\u79CD\u65B9\u5F0F\u652F\u4ED8\u8FDD\u89C4\u5904\u7F5A")):i.paymentType==0?(s(),o("span",J,"\u9009\u62E9\u4E00\u79CD\u65B9\u5F0F\u8D2D\u4E70\u7BA1\u7406\u5458")):r("",!0)]),m(_,{modelValue:e.tokenId,"onUpdate:modelValue":a[0]||(a[0]=p=>e.tokenId=p),onChange:i.changeTokenId},{default:h(()=>[m(f,{class:"radio-item","checked-color":"#9505F9","icon-size":"16px",name:"0"},{default:h(()=>[q]),_:1}),m(f,{class:"radio-item","checked-color":"#9505F9","icon-size":"16px",name:"1"},{default:h(()=>[Q]),_:1})]),_:1},8,["modelValue","onChange"])])):r("",!0),e.isShowApprove?(s(),c(C,{key:3,class:"approve",round:"",type:"primary",onClick:i.approve,loading:e.isApproveLoading},{default:h(()=>[X]),_:1},8,["onClick","loading"])):r("",!0)])):(s(),o("div",Y,[d("div",Z,[e.tradeStatus==0?(s(),o("span",$,"\u53D1\u9001\u4EA4\u6613\u5230\u533A\u5757\u94FE...")):e.tradeStatus==1?(s(),o("span",ee,"\u7B49\u5F85\u670D\u52A1\u5668\u540C\u6B65...")):e.tradeStatus==-1?(s(),o("span",te,"\u4E0A\u94FE\u4EA4\u6613\u53D1\u9001\u5931\u8D25")):e.tradeStatus==-2?(s(),o("span",se,"\u670D\u52A1\u5668\u540C\u6B65\u8D85\u65F6")):r("",!0)]),d("div",ae,[e.tradeStatus==0||e.tradeStatus==1?(s(),c(y,{key:0,type:"spinner",size:"48px"})):r("",!0),e.tradeStatus==2?(s(),c(S,{key:1,color:"#07c160",size:"40px",name:"checked"})):r("",!0),e.tradeStatus==-1||e.tradeStatus==-2?(s(),c(S,{key:2,color:"#FA5151",size:"40px",name:"clear"})):r("",!0)]),d("div",oe,[ie,e.tradeStatus==1||e.tradeStatus==2||e.tradeStatus==-2?(s(),o("text",ne,[d("span",{onClick:a[1]||(a[1]=(...p)=>i.jumpToTxDetail&&i.jumpToTxDetail(...p))},v((w=(g=t.$f).formatAddress)==null?void 0:w.call(g,e.tradeHash,6)),1),(s(),o("svg",{class:"icon-svg icon-renzheng","aria-hidden":"true",onClick:a[2]||(a[2]=p=>i.copy(e.tradeHash))},le))])):e.tradeStatus==0||e.tradeStatus==-1?(s(),o("text",ce,ue)):r("",!0)]),e.tradeStatus==2||e.tradeStatus==-2?(s(),o("div",{key:0,class:"check-trade-list",onClick:a[3]||(a[3]=(...p)=>i.jumpToPaymentList&&i.jumpToPaymentList(...p))}," \u67E5\u770B\u652F\u4ED8\u8BB0\u5F55 ")):r("",!0)]))]}),_:1},8,["visible","title","showConfirmButton","showCancelButton","onOnConfirm","confirmLoading"])}const he=B(H,[["render",pe],["__scopeId","data-v-f109d4d2"]]),me={name:"Group",components:{BlablaPay:he},mounted(){console.log(this.$route.params.groupId)}};function ye(t,a,n,u,e,i){const y=l("router-view"),f=l("BlablaPay");return s(),o(z,null,[m(y,null,{default:h(({Component:_})=>[(s(),c(U,null,[(s(),c(P(_),{key:_}))],1024))]),_:1}),m(f)],64)}const _e=B(me,[["render",ye]]);export{_e as default};
