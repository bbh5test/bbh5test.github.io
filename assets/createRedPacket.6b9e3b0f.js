import{D as N}from"./dialogBase.91be6fe9.js";import{_ as S,c as U,o as d,g as C,w as l,j as i,h as p,t as m,i as w,l as y,r as c,p as I,m as H,e as g,T,s as B,k as n,F as z}from"./index.c8b8f13a.js";const E={name:"ChainTrade",components:{DialogBase:N},props:{tradeVisable:{type:Boolean,default:!1},status:{type:Number,default:0},tradeHash:{type:String,default:""}},emits:["update:tradeVisable"],methods:{copy:U}},F=t=>(I("data-v-a156f7ea"),t=t(),H(),t),M={class:"status-content"},R={class:"status-text"},j={key:0},q={key:1},L={key:2},J={key:3},O={key:4},G={class:"status-icon"},K={class:"trade-hash"},Q={key:0},W=F(()=>i("use",{"xlink:href":"#icon-copy"},null,-1)),X=[W],Y={key:1},Z=F(()=>i("span",null,"N/A",-1)),$=[Z];function ee(t,e,a,k,s,h){const v=c("van-loading"),u=c("van-icon"),_=c("DialogBase");return d(),C(_,{class:"trade-box",visible:a.tradeVisable,"onUpdate:visible":e[2]||(e[2]=r=>a.tradeVisable=r),autoClose:!1,closeable:!1,clickOverlayIsClose:!1,title:t.$t("transactionDetails"),showConfirmButton:!1,showCancelButton:!1},{default:l(()=>[i("div",M,[i("div",R,[a.status==0?(d(),p("span",j,m(t.$t("sendingTransactionToBlockchain")),1)):a.status==1?(d(),p("span",q,m(t.$t("waitingForServiceSyncronizing")),1)):a.status==2?(d(),p("span",L,m(t.$t("transactionSuccess")),1)):a.status==-1?(d(),p("span",J,m(t.$t("sendTransactionToBlockchainFailed")),1)):a.status==-2?(d(),p("span",O,m(t.$t("servicesyncronizingTimeout")),1)):w("",!0)]),i("div",G,[a.status==0||a.status==1?(d(),C(v,{key:0,type:"spinner",size:"48px"})):w("",!0),a.status==2?(d(),C(u,{key:1,color:"#07c160",size:"40px",name:"checked"})):w("",!0),a.status==-1||a.status==-2?(d(),C(u,{key:2,color:"#FA5151",size:"40px",name:"clear"})):w("",!0)]),i("div",K,[y(m(t.$t("txHash")+":")+" ",1),a.status==1||a.status==2||a.status==-2?(d(),p("text",Q,[i("span",{onClick:e[0]||(e[0]=(...r)=>t.jumpToTxDetail&&t.jumpToTxDetail(...r))},m(t.$f.formatAddress(a.tradeHash,6)),1),(d(),p("svg",{class:"icon-svg icon-renzheng","aria-hidden":"true",onClick:e[1]||(e[1]=r=>h.copy(a.tradeHash))},X))])):a.status==0||a.status==-1?(d(),p("text",Y,$)):w("",!0)])])]),_:1},8,["visible","title"])}const te=S(E,[["render",ee],["__scopeId","data-v-a156f7ea"]]),se="/assets/svg/redPacket/luck.svg",oe="/assets/svg/redPacket/redPacket.svg";const ne={name:"CreateRedPacket",components:{ChainTrade:te},computed:{totalAmount(){if(this.type=="0")return this.amount?parseInt(this.amount):0;if(this.type=="1")return this.amount&&this.count?parseInt(this.amount)*parseInt(this.count):0}},data(){return{tradeVisable:!1,tradeStatus:0,tradeHash:"",type:"0",result:"",showTokenPicker:!1,count:"",tokenType:["JF"],amount:"",symbol:"JF",showDeadlinePicker:!1,deadlineList:[{text:"5 Min",value:5*60},{text:"10 Min",value:10*60},{text:"30 Min",value:30*60},{text:"1 H",value:1*60*60},{text:"12 H",value:12*60*60},{text:"24 H",value:24*60*60}],deadline:{text:"5 Min",value:5*60},remark:"",balance:0,tokenAddress:"0xaf22F677373352761B7F8FAfF4c9aD7bd8B6Be42",contractAddress:"0xad3f6E6d8B3D08Ed7d46988fDb4a324e6F6006C6"}},methods:{onTokenConfirm(t){this.balance=0,this.symbol=t,this.showTokenPicker=!1,this.getBalance()},onDeadlineConfirm(t){this.deadline=t,this.showDeadlinePicker=!1},async getBalance(){try{this.balance=await g.contract.getBalance(this.tokenAddress,this.$store.state.user.userAddress)}catch{this.$store.commit("logout")}},async sendRedPacket(){const t=Number(this.amount),e=Number(this.count);if(t<=0){T("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E\u7B49\u4E8E0");return}if(e<1){T("\u6570\u91CF\u4E0D\u80FD\u5C0F\u4E8E1");return}if(e>this.$store.state.group.totalMembers){T("\u6570\u91CF\u4E0D\u80FD\u8D85\u8FC7\u672C\u7FA4\u4EBA\u6570");return}if(Number(this.totalAmount)>this.balance){T("\u4F59\u989D\u4E0D\u8DB3");return}this.tradeStatus=0,this.tradeVisable=!0;try{let k=this.deadline.value;if(console.log("\u53D1\u9001\u7EA2\u5305"),!await this.auth())throw"not auth";console.log("auth");const h={_owner:this.$store.state.user.userAddress,token:this.tokenAddress,amount:t,unlockDate:k,quantity:e,kind:this.type};let v=await g.contract.lock(this.contractAddress,h);console.dir(v);let u=await v.wait();this.tradeStatus=1,this.tradeHash=u.transactionHash,this.tradeVisable=!0,console.dir(u);let _=u==null?void 0:u.events,r={};for(let f=_.length-1;f>=0;f--){let P=_[f].topics.some(o=>o==="0x694af1cc8727cdd0afbdd53d9b87b69248bd490224e9dd090e788546506e076f");if(_[f].address==this.contractAddress&&P){r=_[f];break}}let A=r.data.slice(-128,-64);const V=await g.contract.getDecimal(this.tokenAddress),b=await g.contract.getAmount(this.tokenAddress,"0x"+A),D={groupId:this.$route.params.groupId,contractAddress:this.tokenAddress,contractChain:"eth",contractDecimal:V,count:e,endTime:k,redPacketId:r.topics[1],remark:this.remark,singleAmount:t,symbol:this.symbol,totalAmount:Number(this.totalAmount),tx:u.transactionHash,type:Number(this.type)};await g.redPacket.send(D),this.tradeStatus=2,await B(1e3),this.$router.push({name:"Chat",params:{groupId:this.$route.params.groupId}})}catch(k){console.log(k),this.tradeStatus=-1,await B(1e3),this.tradeVisable=!1}},async auth(){let t=await this.allowance();if(!t){const e=await this.approve(this.contractAddress,this.tokenAddress);console.log("approve",e),e&&(t=await this.allowance())}return t},async allowance(){const t=await g.contract.allowanceSend({spender:this.contractAddress,tokenAddress:this.tokenAddress,account:this.$store.state.user.userAddress});return console.log("allowanceSend",t),t}},mounted(){this.getBalance()}},x=t=>(I("data-v-7957e9bd"),t=t(),H(),t),ae={class:"myChats-container"},ie={class:"body"},le=y("\u62FC\u624B\u6C14\u7EA2\u5305"),re=y("\u666E\u901A\u7EA2\u5305"),de=x(()=>i("img",{class:"left-icon",src:se,alt:"",srcset:""},null,-1)),ce={class:"right-text"},ue={class:"desc-text margin-bottom"},me=x(()=>i("img",{class:"left-icon",src:oe,alt:"",srcset:""},null,-1)),he=x(()=>i("div",{class:"right-text"},"\u4E2A",-1)),pe={class:"desc-text margin-bottom"},_e={class:"total"},fe=y("\u7EA2\u5305\u603B\u989D"),ke={class:"amount"},ve={style:{margin:"16px"}},be=y(" \u585E\u5E01\u8FDB\u7EA2\u5305 "),ge=x(()=>i("div",{class:"bottom"},"\u672A\u9886\u53D6\u7684\u7EA2\u5305, \u5C06\u572824\u5C0F\u65F6\u540E\u9000",-1));function ye(t,e,a,k,s,h){const v=c("van-nav-bar"),u=c("van-radio"),_=c("van-radio-group"),r=c("van-field"),A=c("van-picker"),V=c("van-popup"),b=c("van-cell-group"),D=c("van-button"),f=c("van-form"),P=c("ChainTrade");return d(),p(z,null,[i("section",ae,[n(v,{fixed:"",placeholder:"","left-arrow":"","safe-area-inset-top":"","z-index":"2",title:"\u521B\u5EFA\u7EA2\u5305",onClickLeft:e[0]||(e[0]=o=>t.$router.push({name:"Chat",params:{groupId:t.$route.params.groupId}}))}),i("div",ie,[n(f,{onSubmit:h.sendRedPacket},{default:l(()=>[n(r,{name:"type",class:"red-packet-type"},{input:l(()=>[n(_,{modelValue:s.type,"onUpdate:modelValue":e[1]||(e[1]=o=>s.type=o),direction:"horizontal"},{default:l(()=>[n(u,{"checked-color":"#ED4A4A",name:"0"},{default:l(()=>[le]),_:1}),n(u,{"checked-color":"#ED4A4A",name:"1"},{default:l(()=>[re]),_:1})]),_:1},8,["modelValue"])]),_:1}),n(b,{inset:"",class:"margin-bottom"},{default:l(()=>[n(r,{modelValue:s.symbol,"onUpdate:modelValue":e[2]||(e[2]=o=>s.symbol=o),"is-link":"",readonly:"",name:"picker",label:"\u5E01\u79CD",placeholder:"\u9009\u62E9\u5E01\u79CD",onClick:e[3]||(e[3]=o=>s.showTokenPicker=!0),"input-align":"right"},null,8,["modelValue"]),n(V,{show:s.showTokenPicker,"onUpdate:show":e[5]||(e[5]=o=>s.showTokenPicker=o),position:"bottom"},{default:l(()=>[n(A,{columns:s.tokenType,onCancel:e[4]||(e[4]=o=>s.showTokenPicker=!1),onConfirm:h.onTokenConfirm},null,8,["columns","onConfirm"])]),_:1},8,["show"])]),_:1}),n(b,{inset:""},{default:l(()=>[n(r,{label:"\u91D1\u989D",class:"ipt-num"},{"left-icon":l(()=>[de]),input:l(()=>[n(r,{"input-align":"right",modelValue:s.amount,"onUpdate:modelValue":e[6]||(e[6]=o=>s.amount=o),type:"number",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u91D1\u989D"}]},null,8,["modelValue"]),i("div",ce,m(s.symbol),1)]),_:1})]),_:1}),i("div",ue,"\u53EF\u7528\u4F59\u989D "+m((s.balance?s.balance:"--")+" "+s.symbol),1),n(b,{inset:""},{default:l(()=>[n(r,{label:"\u7EA2\u5305\u4E2A\u6570",class:"ipt-num"},{"left-icon":l(()=>[me]),input:l(()=>[n(r,{"input-align":"right",modelValue:s.count,"onUpdate:modelValue":e[7]||(e[7]=o=>s.count=o),type:"digit",rules:[{required:!0,message:"\u8BF7\u8F93\u5165\u7EA2\u5305\u4E2A\u6570"}]},null,8,["modelValue"]),he]),_:1})]),_:1}),i("div",pe,"\u672C\u7FA4\u5171 "+m(t.$store.state.group.totalMembers)+" \u4EBA",1),n(b,{inset:"",class:"margin-bottom"},{default:l(()=>[n(r,{modelValue:s.deadline.text,"onUpdate:modelValue":e[8]||(e[8]=o=>s.deadline.text=o),"is-link":"",readonly:"",name:"picker",label:"\u8FC7\u671F\u65F6\u95F4",placeholder:"\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4",onClick:e[9]||(e[9]=o=>s.showDeadlinePicker=!0),"input-align":"right"},null,8,["modelValue"]),n(V,{show:s.showDeadlinePicker,"onUpdate:show":e[11]||(e[11]=o=>s.showDeadlinePicker=o),position:"bottom"},{default:l(()=>[n(A,{columns:s.deadlineList,onCancel:e[10]||(e[10]=o=>s.showDeadlinePicker=!1),onConfirm:h.onDeadlineConfirm},null,8,["columns","onConfirm"])]),_:1},8,["show"])]),_:1}),n(b,{inset:""},{default:l(()=>[n(r,{modelValue:s.remark,"onUpdate:modelValue":e[12]||(e[12]=o=>s.remark=o),rows:"3",autosize:"",placeholder:"\u606D\u559C\u53D1\u8D22\uFF0C\u9886\u53D6\u7A7A\u6295",type:"textarea",maxlength:"32"},null,8,["modelValue"])]),_:1}),i("div",_e,[fe,i("span",ke,m(h.totalAmount?h.totalAmount:"--"),1),y(m(s.symbol),1)]),i("div",ve,[n(D,{round:"",block:"",type:"default","native-type":"submit"},{default:l(()=>[be]),_:1})])]),_:1},8,["onSubmit"]),ge])]),n(P,{tradeVisable:s.tradeVisable,"onUpdate:tradeVisable":e[13]||(e[13]=o=>s.tradeVisable=o),status:s.tradeStatus,tradeHash:s.tradeHash},null,8,["tradeVisable","status","tradeHash"])],64)}const Ve=S(ne,[["render",ye],["__scopeId","data-v-7957e9bd"]]);export{Ve as default};
