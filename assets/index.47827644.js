import{_ as V,r as l,o as d,g as p,i as r,j as n,t as f,d as b,w as a,F as y,h as w,n as O,f as v,k as m,q as Y,v as R,u as P,C as A,D as H,R as F,A as N,T as _,x as U,p as j,l as z}from"./index.2b2030c9.js";const G={name:"ChatNotice",props:{content:{type:String,default:""}},emits:["onClose","onPinedClick"],computed:{},methods:{onClose(){this.$emit("onClose")},onPinedClick(){this.$emit("onPinedClick")}}},J={class:"chat-notice"},q={class:"icon-box"};function K(t,e,c,C,o,s){const u=l("van-icon");return d(),p("div",J,[r("div",q,[n(u,{class:"icon",size:"24px",name:"/assets/images/horn.png"})]),r("div",{class:"text",onClick:e[0]||(e[0]=(...g)=>s.onPinedClick&&s.onPinedClick(...g))},f(c.content),1),r("div",{class:"icon-box",onClick:e[1]||(e[1]=(...g)=>s.onClose&&s.onClose(...g))},[n(u,{class:"icon close",size:"24px",name:"cross"})])])}const Q=V(G,[["render",K],["__scopeId","data-v-bf332d48"]]),W={name:"ChatBar",props:{reply:{type:Object,default:null}},emits:["chatBarToolClick","onFocus"],data(){return{text:"",lastSendTime:0,slowSendTimer:0,sendCountdown:"",showTools:!1,toolList:[{key:"redPacket",icon:"/assets/images/redPacket.png",text:"\u7EA2\u5305"}],sendLoading:!1}},computed:{status(){if(this.$store.state.group.isJoined){if(this.$store.state.group.status==0&&this.$store.state.group.currentUser.status==0)return 0;if(this.$store.state.group.status==1||this.$store.state.group.currentUser.status==1)return 1;if(this.$store.state.group.status==2||this.$store.state.group.currentUser.status==2)return 2;if(this.$store.state.group.status==3||this.$store.state.group.currentUser.status==3)return 3}else return-1;return-2},bannedExpiredTime(){return this.$store.state.group.status==1?this.$dayjs.unix(this.$store.state.group.bannedExpiredTime).format("YYYY-MM-DD HH:mm:ss"):this.$dayjs.unix(this.$store.state.group.currentUser.bannedExpiredTime).format("YYYY-MM-DD HH:mm:ss")},replyItem:{get(){return this.reply},set(t){this.$emit("update:reply",t)}},inputPlaceholder(){return this.$store.state.group.tokenPrice.price?`\u8F93\u5165\u804A\u5929 | $${this.$store.state.group.tokenPrice.price.toFixed(1)}  ${this.$store.state.group.tokenPrice.direction=="up"?"+":""}${this.$store.state.group.tokenPrice.priceChange}%`:"\u8F93\u5165\u804A\u5929"},inputPlaceholderColor(){return this.$store.state.group.tokenPrice.price?this.$store.state.group.tokenPrice.direction=="up"?"token-price-up":"token-price-down":""}},methods:{focus(){this.showTools=!1,this.$emit("onFocus")},async onSend(){this.sendLoading=!0,(await b.group.sendMsg(this.text,this.$store.state.group.groupId,this.replyItem?this.replyItem.toId:0,1)).status==1&&(this.replyItem=null,this.text="",this.showTools=!1,this.lastSendTime=parseInt(new Date().getTime()/1e3)),this.sendLoading=!1,this.status==3&&(this.sendCountdown=this.calcCountdown(30),this.slowSendTimer=setInterval(()=>{let c=parseInt(new Date().getTime()/1e3),C=this.lastSendTime+30-c;C>0?this.sendCountdown=this.calcCountdown(C):(clearInterval(this.slowSendTimer),this.slowSendTimer=0,this.sendCountdown="")},1e3))},calcCountdown(t){let e=parseInt(t/60),c=t%60;return e>0?e+":"+(c+"").padStart(2,"0"):c+""},onJoin(){this.$store.dispatch("joinGroup",this.$store.state.group.groupId)},onChatBarToolClick(t){this.$emit("chatBarToolClick",t)}}},X={class:"chat-bar"},Z={key:0,class:"action-btn"},ee=m("\u52A0\u5165"),te={key:0,class:"reply"},se={class:"icon-box"},oe={class:"reply-info"},ne={class:"to"},ie=m("\u56DE\u590D"),re={class:"msg"},ae={class:"action"},le={class:"tools"},de={key:2,class:"action-btn"},ce={key:3,class:"action-btn"},ue=m("\u6C38\u4E45\u7981\u8A00");function he(t,e,c,C,o,s){const u=l("van-button"),g=l("van-icon"),x=l("van-field"),T=l("van-grid-item"),B=l("van-grid");return d(),p("div",X,[s.status==-1?(d(),p("div",Z,[n(u,{class:"join",type:"default",round:"",block:"",onClick:s.onJoin},{default:a(()=>[ee]),_:1},8,["onClick"])])):s.status==0||s.status==3?(d(),p(y,{key:1},[s.replyItem?(d(),p("div",te,[r("div",se,[n(g,{class:"icon",size:"24px",name:"/assets/images/reply.png"})]),r("div",oe,[r("div",ne,[ie,r("span",null,f(s.replyItem.toName),1)]),r("div",re,f(s.replyItem.toMsg),1)]),r("div",{class:"icon-box",onClick:e[0]||(e[0]=h=>c.reply=null)},[n(g,{class:"icon close",size:"24px",name:"cross"})])])):w("",!0),r("div",ae,[n(u,{class:"btn",icon:"/assets/images/add.png",onClick:e[1]||(e[1]=h=>o.showTools=!o.showTools)}),n(x,{class:O(["input",s.inputPlaceholderColor]),onFocus:s.focus,modelValue:o.text,"onUpdate:modelValue":e[2]||(e[2]=h=>o.text=h),placeholder:s.inputPlaceholder,type:"textarea",rows:"1",autosize:{maxHeight:100},maxlength:"4096"},null,8,["class","onFocus","modelValue","placeholder"]),s.status==3&&o.sendCountdown?(d(),v(u,{key:0,class:"btn",disabled:""},{default:a(()=>[m(f(o.sendCountdown),1)]),_:1})):(d(),v(u,{key:1,class:"btn",icon:"/assets/images/send.png",onClick:s.onSend,loading:o.sendLoading},null,8,["onClick","loading"]))]),Y(r("div",le,[n(B,{"column-num":4,"icon-size":"54px",border:!1},{default:a(()=>[(d(!0),p(y,null,P(o.toolList,h=>(d(),v(T,{key:h.key,icon:h.icon,text:h.text,onClick:I=>t.$emit("chatBarToolClick",h.key)},null,8,["icon","text","onClick"]))),128))]),_:1})],512),[[R,o.showTools]])],64)):s.status==1?(d(),p("div",de,[n(u,{type:"default",disabled:"",round:"",block:""},{default:a(()=>[m("\u7981\u8A00\u4E2D, \u89E3\u7981\u65F6\u95F4"+f(s.bannedExpiredTime),1)]),_:1})])):s.status==2?(d(),p("div",ce,[n(u,{type:"default",disabled:"",round:"",block:""},{default:a(()=>[ue]),_:1})])):w("",!0)])}const pe=V(W,[["render",he],["__scopeId","data-v-255677cd"]]),me={name:"Chat",components:{ChatItem:A,ChatNotice:Q,DialogBase:H,RedPacket:F,ChatBar:pe,Avatar:N},data(){return{listLoading:!1,listFinished:!1,banVisable:!1,banChecked:"2",banUserAddress:"",selectBanExpiredVisable:!1,banExpired:new Date,banMinTime:new Date,removeVisable:!1,removeChecked:"1",removeUserAddress:"",pinedVisible:!0,reply:null,scrollTop:0}},computed:{group(){return this.$store.state.group}},watch:{"$store.state.ws.status"(t){let e;t==1?e=_.loading({message:"Loading...",forbidClick:!0}):e&&e.clear()},"$store.state.group.msgList.length":{handler(t,e){this.$refs.rightBody.scrollTop+this.$refs.rightBody.clientHeight==this.$refs.rightBody.scrollHeight&&this.scrollToBottom()},deep:!0},"$store.state.group.status"(t){switch(t){case 1:_("\u8BE5\u7FA4\u5DF2\u88AB\u7981\u8A00\u5904\u7F5A\u81F3"+this.$dayjs.unix(this.$store.state.group.bannedExpired).format("YYYY-MM-DD HH:mm:ss"));break;case 2:_("\u8BE5\u7FA4\u5DF2\u88AB\u6C38\u4E45\u7981\u8A00\u5904\u7F5A");break;case 3:_("\u8BE5\u7FA4\u5DF2\u88AB\u6162\u901F\u53D1\u8A00\u5904\u7F5A,\u53D1\u8A00\u95F4\u969430\u79D2");break;case 4:U.alert({title:"\u63D0\u793A",message:"\u8BE5\u7FA4\u5DF2\u88AB\u5C01\u7981"}).then(()=>{this.$router.push("/chats")});break}},"$store.state.group.currentUser.status"(t){switch(t){case 5:U.alert({title:"\u63D0\u793A",message:"\u60A8\u5DF2\u88AB\u8E22\u51FA\u7FA4\u804A"}).then(()=>{this.$router.push("/chats")});break}}},methods:{async onLastPage(){let t=-1;this.$store.state.group.msgList.length>0&&(t=this.$store.state.group.msgList[0].id);let e=await b.group.getMsgList(this.$store.state.group.groupId,10,t);if(e.status==1){if(e.data.length>0)for(let c=e.data.length-1;c>=0;c--)this.$store.commit("addMsgUnshift",e.data[c]);e.data.length<10&&(this.listFinished=!0)}this.$refs.rightBody.scrollTop=1,this.listLoading=!1},onBanUser(t){this.banMinTime=new Date;let e=new Date;this.banExpired=new Date(e.setDate(e.getDate()+1)),this.banUserAddress=t,this.banVisable=!0},clickSelectBanExpired(){this.banChecked="1",this.selectBanExpiredVisable=!0},async banConfirm(){let t=0;this.banChecked=="1"&&(t=this.$dayjs(this.banExpired).unix()),(await b.groupMember.banMember(this.group.groupId,this.banUserAddress,parseInt(this.banChecked),t)).status==1&&_.success("\u7981\u8A00\u7528\u6237\u6210\u529F"),this.banUserAddress=""},onRemoveUser(t){this.removeUserAddress=t,this.removeVisable=!0},async removeConfirm(){this.removeChecked=="2"?(await b.user.blockUser(this.removeUserAddress)).status==1&&_.success("\u8E22\u51FA\u7528\u6237\u6210\u529F"):(await b.groupMember.removeMember(this.group.groupId,this.removeUserAddress)).status==1&&_.success("\u8E22\u51FA\u7528\u6237\u6210\u529F"),this.removeUserAddress=""},onReply(t){this.reply={toId:t.id,toName:this.$f.getUserShowName(t),toMsg:t.content}},onPinedClick(){this.$router.push("/group/"+this.$route.params.groupId+"/pined")},ok:()=>{console.log("11111"),U.alert({title:"\u6807\u9898",message:"\u4EE3\u7801\u662F\u5199\u51FA\u6765\u7ED9\u4EBA\u770B\u7684\uFF0C\u9644\u5E26\u80FD\u5728\u673A\u5668\u4E0A\u8FD0\u884C\u3002"})},toChats(){this.$router.push("/chats")},toGroupDetail(){this.$router.push("/group/"+this.$route.params.groupId+"/detail")},onChatBarToolClick(t){switch(t){case"redPacket":this.$router.push("/group/"+this.$route.params.groupId+"/createRedPacket");break}},scrollToBottom(){this.$nextTick(()=>{this.$refs.rightBody.scrollTop=this.$refs.rightBody.scrollHeight}),this.scrollTop=this.$refs.rightBody.scrollHeight}},mounted(){this.scrollToBottom()},beforeRouteLeave(t,e){this.scrollTop=this.$refs.rightBody.scrollTop},activated(){this.$refs.rightBody.scrollTop=this.scrollTop}},ge=t=>(j("data-v-d5266ef6"),t=t(),z(),t),fe={class:"chat-container"},_e={class:"nav-bar"},ve={class:"info"},Ce={class:"title-line"},be={class:"title"},ke={class:"desc"},ye=ge(()=>r("i",{class:"iconfont icon-set"},null,-1)),we={class:"chat-content",ref:"rightBody"},xe={"safe-area-inset-bottom":""},Te=m("\u8E22\u51FA\u5F53\u524D\u7FA4\u804A\u53CA\u5220\u9664\u6240\u6709\u6D88\u606F"),Be=m("\u8E22\u51FA Ta \u7684\u6240\u6709\u7FA4\u804A\u53CA\u5220\u9664\u6240\u6709\u6D88\u606F"),Ue=m("\u6C38\u4E45\u7981\u8A00"),Ve=m("\u7981\u8A00\u81F3");function Ie(t,e,c,C,o,s){var D;const u=l("van-icon"),g=l("Avatar"),x=l("van-nav-bar"),T=l("ChatNotice"),B=l("ChatItem"),h=l("van-cell"),I=l("van-list"),M=l("ChatBar"),k=l("van-radio"),$=l("van-radio-group"),L=l("DialogBase"),E=l("van-datetime-picker"),S=l("van-popup");return d(),p(y,null,[r("section",fe,[r("div",null,[n(x,{fixed:"",placeholder:"","safe-area-inset-top":"",onClickLeft:s.toChats,onClickRight:s.toGroupDetail},{left:a(()=>[n(u,{name:"wap-nav"})]),title:a(()=>[r("div",_e,[n(g,{class:"avatar",image:s.group.image,address:s.group.address},null,8,["image","address"]),r("div",ve,[r("div",Ce,[r("div",be,f(t.$f.getGroupShowName({address:s.group.groupId.split("-")[0],name:s.group.name,nickname:s.group.nickname})),1),t.$store.state.group.providers&&t.$store.state.group.providers.length>0?(d(),v(u,{key:0,size:"0.4rem",name:"/assets/images/certification.png"})):w("",!0)]),r("div",ke,f(s.group.totalMembers)+"\u4EBA",1)])])]),right:a(()=>[ye]),_:1},8,["onClickLeft","onClickRight"]),((D=s.group.pinedMsgList)==null?void 0:D.length)>0&&o.pinedVisible?(d(),v(T,{key:0,onOnClose:e[0]||(e[0]=i=>o.pinedVisible=!1),content:s.group.pinedMsgList[s.group.pinedMsgList.length-1].content,onOnPinedClick:s.onPinedClick},null,8,["content","onOnPinedClick"])):w("",!0)]),r("div",we,[n(I,{loading:o.listLoading,"onUpdate:loading":e[1]||(e[1]=i=>o.listLoading=i),class:"chat-list",direction:"up",onLoad:s.onLastPage,"immediate-check":!1,finished:o.listFinished,"loading-text":"\u8F7D\u5165\u4E2D"},{default:a(()=>[(d(!0),p(y,null,P(s.group.msgList,i=>(d(),v(h,{key:i.id},{default:a(()=>[n(B,{source:i,onOnReply:$e=>s.onReply(i),onOnRemoveUser:s.onRemoveUser,onOnBanUser:s.onBanUser},null,8,["source","onOnReply","onOnRemoveUser","onOnBanUser"])]),_:2},1024))),128))]),_:1},8,["loading","onLoad","finished"])],512),r("div",xe,[n(M,{reply:o.reply,"onUpdate:reply":e[2]||(e[2]=i=>o.reply=i),onChatBarToolClick:s.onChatBarToolClick,onOnFocus:s.scrollToBottom},null,8,["reply","onChatBarToolClick","onOnFocus"])])]),n(L,{visible:o.removeVisable,"onUpdate:visible":e[4]||(e[4]=i=>o.removeVisable=i),title:"\u8E22\u51FA\u7FA4\u804A",showConfirmButton:!0,showCancelButton:!0,onOnConfirm:s.removeConfirm},{default:a(()=>[n($,{modelValue:o.removeChecked,"onUpdate:modelValue":e[3]||(e[3]=i=>o.removeChecked=i)},{default:a(()=>[n(k,{name:"1"},{default:a(()=>[Te]),_:1}),n(k,{name:"2"},{default:a(()=>[Be]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["visible","onOnConfirm"]),n(L,{visible:o.banVisable,"onUpdate:visible":e[11]||(e[11]=i=>o.banVisable=i),title:"\u7981\u8A00\u65F6\u6548\u8BBE\u7F6E",showConfirmButton:!0,showCancelButton:!0,onOnConfirm:s.banConfirm},{default:a(()=>[n($,{modelValue:o.banChecked,"onUpdate:modelValue":e[10]||(e[10]=i=>o.banChecked=i)},{default:a(()=>[n(k,{name:"2"},{default:a(()=>[Ue]),_:1}),n(k,{name:"1"},{default:a(()=>[Ve]),_:1}),r("div",{class:"ban-date-time",onClick:e[5]||(e[5]=(...i)=>s.clickSelectBanExpired&&s.clickSelectBanExpired(...i))},f(t.$dayjs(o.banExpired).format("YYYY-MM-DD HH:mm:ss")),1),n(S,{show:o.selectBanExpiredVisable,"onUpdate:show":e[9]||(e[9]=i=>o.selectBanExpiredVisable=i),teleport:"#app",position:"bottom"},{default:a(()=>[n(E,{modelValue:o.banExpired,"onUpdate:modelValue":e[6]||(e[6]=i=>o.banExpired=i),type:"datetime","min-date":o.banMinTime,onCancel:e[7]||(e[7]=i=>o.selectBanExpiredVisable=!1),onConfirm:e[8]||(e[8]=i=>o.selectBanExpiredVisable=!1)},null,8,["modelValue","min-date"])]),_:1},8,["show"])]),_:1},8,["modelValue"])]),_:1},8,["visible","onOnConfirm"])],64)}const De=V(me,[["render",Ie],["__scopeId","data-v-d5266ef6"]]);export{De as default};
